<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ATLAS Workspace â€” Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ</title>
  <meta name="theme-color" content="#05060a"/>
  <style>
    :root{
      --bg: #0a0d14;
      --bg2:#0f1420;
      --card:#131a28;
      --card2:#0e1524;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --accent:#4ea1ff;
      --accent2:#7b61ff;
      --ok:#35d07f;
      --warn:#ffcc55;
      --danger:#ff6b6b;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --glass: rgba(255,255,255,.04);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.08);
      --font: "system-ui",-apple-system,"Segoe UI",Tahoma,Arial;
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --bg2:#eef2f9; --card:#ffffff; --card2:#f7f9ff;
      --text:#0e1320; --muted:#55657e; --border:rgba(0,0,0,.08);
      --glass: rgba(0,0,0,.03); --glass2: rgba(0,0,0,.05);
      --shadow: 0 10px 25px rgba(20,30,50,.12);
    }
    [data-theme="oled"]{
      --bg:#000000; --bg2:#030307; --card:#05060a; --card2:#0a0b10;
      --text:#ecf2ff; --muted:#8ea0bd; --border:rgba(255,255,255,.07);
      --shadow: 0 10px 28px rgba(0,0,0,.9);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); background:
        radial-gradient(1200px 800px at 80% -10%, #1c2a66 0%, transparent 55%),
        radial-gradient(1200px 800px at -10% 30%, #1d3a2a 0%, transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* Layout */
    .app{
      max-width:1400px; margin:0 auto; padding:16px; display:grid; gap:14px;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "sidebar topbar profile"
        "sidebar main profile"
        "sidebar footer footer";
    }
    @media (max-width:1100px){
      .app{
        grid-template-columns: 1fr;
        grid-template-areas:
          "topbar"
          "main"
          "profile"
          "sidebar"
          "footer";
      }
    }

    /* Cards */
    .card{
      background:linear-gradient(180deg,var(--glass2),transparent),var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    /* Sidebar */
    .sidebar{grid-area:sidebar; position:sticky; top:12px; height:fit-content}
    .logo{
      display:flex; align-items:center; gap:10px; padding:10px 8px; margin-bottom:8px;
    }
    .logo .mark{
      width:44px;height:44px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #7b61ff, transparent 60%),
                  radial-gradient(circle at 70% 70%, #4ea1ff, transparent 60%),
                  #0d1220;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
    }
    .logo h1{font-size:18px;margin:0}
    .logo small{color:var(--muted)}
    .nav{
      display:grid; gap:8px; margin-top:6px;
    }
    .nav button{
      width:100%; text-align:right; padding:10px 12px; border-radius:12px;
      background:var(--card2); border:1px solid var(--border); color:var(--text);
      display:flex; align-items:center; justify-content:space-between; cursor:pointer;
      transition:.15s;
    }
    .nav button:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
    .nav button.active{
      background:linear-gradient(90deg,rgba(78,161,255,.16),transparent),var(--card2);
      border-color:rgba(78,161,255,.55);
      box-shadow:0 0 0 2px rgba(78,161,255,.15) inset;
    }

    /* Topbar */
    .topbar{grid-area:topbar; display:flex; gap:10px; align-items:center}
    .pill{
      background:var(--card); border:1px solid var(--border);
      padding:8px 10px; border-radius:12px; display:flex; gap:8px; align-items:center;
      box-shadow:var(--shadow);
    }
    .search{
      flex:1; display:flex; align-items:center; gap:8px;
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:8px 10px;
    }
    .search input{
      flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px;
    }

    .theme-row{display:flex; gap:6px; flex-wrap:wrap}
    .theme-btn{
      padding:7px 10px;border-radius:10px;border:1px solid var(--border);
      background:var(--card2); color:var(--text); cursor:pointer; font-size:12px;
    }
    .theme-btn.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(78,161,255,.15) inset;}

    /* Profile right */
    .profile{grid-area:profile; position:sticky; top:12px; height:fit-content}
    .profile-head{
      display:flex; align-items:center; gap:10px; margin-bottom:10px;
    }
    .avatar{
      width:44px;height:44px;border-radius:50%; background:var(--card2);
      border:1px solid var(--border); display:grid; place-items:center; font-weight:800;
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .profile-actions{display:flex; gap:6px; flex-wrap:wrap}
    .btn{
      padding:9px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--card2);color:var(--text);cursor:pointer;font-weight:600;
      transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,rgba(78,161,255,.2),rgba(123,97,255,.2)),var(--card2); border-color:rgba(78,161,255,.5)}
    .btn.danger{border-color:rgba(255,107,107,.6); background:rgba(255,107,107,.08)}

    /* Main */
    .main{grid-area:main; min-height:60vh}
    .section{display:none}
    .section.active{display:block}

    /* Home */
    .home-grid{
      display:grid; grid-template-columns:1.2fr 1fr; gap:12px;
    }
    @media (max-width:900px){.home-grid{grid-template-columns:1fr}}
    .welcome{
      padding:18px; display:grid; gap:6px; background:
        radial-gradient(800px 600px at 100% 0%, rgba(78,161,255,.25), transparent 55%),
        radial-gradient(800px 600px at 0% 100%, rgba(123,97,255,.25), transparent 55%),
        var(--card);
    }
    .welcome h2{margin:0;font-size:22px}
    .welcome p{margin:0;color:var(--muted);line-height:1.7}
    .quick-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:650px){.quick-cards{grid-template-columns:1fr 1fr}}
    .quick{
      padding:12px;border-radius:14px;background:var(--card2);
      border:1px solid var(--border); display:grid; gap:6px;
    }
    .quick .t{font-weight:700}
    .quick .s{color:var(--muted);font-size:12px}

    /* Tracker widgets */
    .tracker-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .tracker{
      background:var(--card2); border:1px solid var(--border); border-radius:14px;
      padding:10px; display:grid; gap:8px;
    }
    .tracker .row{display:flex;justify-content:space-between;align-items:center}
    .counter{
      display:flex;gap:6px;align-items:center;
    }
    .counter button{
      width:28px;height:28px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);color:var(--text);cursor:pointer;font-weight:900;
    }
    .counter input{
      width:64px;text-align:center;background:var(--card);border:1px solid var(--border);
      color:var(--text);border-radius:8px;padding:5px 6px;outline:none;
    }
    .small{font-size:12px;color:var(--muted)}

    /* Notes */
    .notes-wrap{display:grid; grid-template-columns:320px 1fr; gap:12px;}
    @media(max-width:900px){.notes-wrap{grid-template-columns:1fr}}
    .notes-list{
      display:grid; gap:8px; max-height:72vh; overflow:auto; padding-right:2px;
    }
    .note-item{
      padding:10px;border-radius:12px;background:var(--card2);border:1px solid var(--border);
      display:flex;gap:10px;align-items:center;cursor:pointer;
      transition:.12s;
    }
    .note-item:hover{transform:translateY(-1px); border-color:rgba(78,161,255,.4)}
    .note-item.active{border-color:var(--accent)}
    .note-thumb{
      width:44px;height:44px;border-radius:10px;background:var(--card);
      display:grid;place-items:center;font-size:22px;overflow:hidden;border:1px solid var(--border);
    }
    .note-thumb img{width:100%;height:100%;object-fit:cover}
    .note-meta{display:grid;gap:2px}
    .note-meta .title{font-weight:700}
    .note-meta .date{font-size:11px;color:var(--muted)}

    .editor{
      min-height:72vh; display:grid; gap:10px;
    }
    .editor-top{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .editor-top .left, .editor-top .right{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .title-input{
      width:100%; font-size:26px; font-weight:800; background:transparent; border:0; outline:0; color:var(--text);
    }
    .cover{
      height:160px;border-radius:16px;background:var(--card2);border:1px dashed var(--border);
      display:grid;place-items:center;overflow:hidden; position:relative;
    }
    .cover img{width:100%;height:100%;object-fit:cover}
    .cover .cover-actions{
      position:absolute; bottom:8px; left:8px; display:flex; gap:6px;
    }

    .toolbar{
      display:flex;gap:6px;flex-wrap:wrap;padding:8px;border-radius:12px;background:var(--card2);border:1px solid var(--border);
      position:sticky;top:6px;z-index:2;
    }
    .tool{
      padding:6px 8px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);cursor:pointer;font-size:12px;color:var(--text);
    }
    .tool select, .tool input[type="color"]{
      background:transparent;border:0;color:var(--text);outline:0;font-size:12px;cursor:pointer;
    }

    .content{
      background:var(--card2); border:1px solid var(--border); border-radius:12px;
      padding:12px; min-height:350px; line-height:1.8;
    }
    .content[contenteditable="true"]:focus{outline:2px solid rgba(78,161,255,.25)}
    .content img{max-width:100%;border-radius:12px;margin:8px 0}
    .content .block{
      padding:6px 4px; border-radius:8px;
    }

    /* PDF Tools */
    .pdf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.pdf-grid{grid-template-columns:1fr}}
    .pdf-card{display:grid;gap:8px}
    .drop{
      border:1px dashed var(--border); border-radius:12px; padding:14px; text-align:center; background:var(--card2);
    }
    .drop input{display:none}
    .drop label{cursor:pointer;display:block}

    /* Timer */
    .timer-wrap{
      display:grid; gap:10px; grid-template-columns:1fr 1fr;
    }
    @media(max-width:900px){.timer-wrap{grid-template-columns:1fr}}
    .timer-display{
      font-size:56px; font-weight:900; text-align:center; padding:22px; background:var(--card2);
      border:1px solid var(--border); border-radius:16px;
    }
    .timer-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    /* Footer */
    .footer{grid-area:footer; text-align:center; color:var(--muted); font-size:12px; padding:8px 0}

    /* Modal */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; z-index:10;
      padding:14px;
    }
    .modal.active{display:grid}
    .modal .box{
      width:min(520px,100%); background:var(--card); border:1px solid var(--border);
      border-radius:18px; padding:14px; display:grid; gap:10px;
      box-shadow:var(--shadow);
    }
    .field{
      display:grid; gap:6px;
    }
    .field input{
      background:var(--card2); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px; outline:none;
    }

    .hint{color:var(--muted); font-size:12px; line-height:1.6}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px; background:var(--glass2); border:1px solid var(--border)
    }
  
    /* ===== Notion Notes Mode (OLED) ===== */
    body.notes-mode{
      background:#000 !important;
    }
    body.notes-mode .sidebar,
    body.notes-mode .profile,
    body.notes-mode .topbar,
    body.notes-mode .footer{
      display:none !important;
    }
    body.notes-mode .app{
      grid-template-columns: 1fr !important;
      grid-template-areas:
        "main" !important;
      max-width:100% !important;
      padding:0 !important;
    }
    body.notes-mode .main{padding:0 !important;}

    .notion-shell{
      display:grid;
      grid-template-columns: 260px 1fr;
      height:100vh;
      background:#000;
      color:var(--text);
    }
    @media(max-width:900px){
      .notion-shell{grid-template-columns: 1fr;}
      .notion-side{position:sticky; top:0; z-index:5;}
    }

    .notion-side{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent), #05060a;
      border-left:1px solid rgba(255,255,255,.06);
      padding:12px;
      display:grid;
      grid-template-rows:auto auto 1fr auto;
      gap:10px;
      overflow:auto;
    }
    .notion-user{
      display:flex; align-items:center; gap:8px;
      padding:8px; border-radius:10px; background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
    }
    .notion-user .uava{
      width:34px;height:34px;border-radius:50%;overflow:hidden;background:#111;border:1px solid rgba(255,255,255,.08);
      display:grid;place-items:center;font-weight:800;
    }
    .notion-user .uava img{width:100%;height:100%;object-fit:cover}
    .notion-search{
      display:flex; gap:6px; align-items:center; background:#0a0b10; border:1px solid rgba(255,255,255,.08);
      padding:6px 8px; border-radius:10px;
    }
    .notion-search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:13px}

    .side-section{display:grid; gap:6px;}
    .side-title{font-size:12px;color:var(--muted);padding:0 6px;margin-top:4px}
    .side-item{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer;
      color:var(--text); background:transparent; border:1px solid transparent;
    }
    .side-item:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06)}
    .side-item.active{background:rgba(78,161,255,.12); border-color:rgba(78,161,255,.5)}
    .side-item .dot{opacity:.7}

    .page-list{display:grid; gap:6px; padding:0 4px;}
    .page-row{
      display:flex; align-items:center; gap:8px; padding:7px 8px; border-radius:8px; cursor:pointer;
      background:#0a0b10; border:1px solid rgba(255,255,255,.06);
      font-size:13px;
    }
    .page-row:hover{border-color:rgba(78,161,255,.5)}
    .page-row.active{border-color:var(--accent)}
    .page-row .fav{margin-inline-start:auto; opacity:.8}

    .notion-editor{
      overflow:auto;
      background:#000;
    }
    .page-cover{
      height:220px; background:#05060a; border-bottom:1px solid rgba(255,255,255,.06);
      position:relative; display:grid; place-items:center; overflow:hidden;
    }
    .page-cover img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;opacity:1}
    .cover-actions{
      position:absolute; top:12px; inset-inline-start:12px; display:flex; gap:6px; z-index:2;
    }
    .cover-actions .mini{
      padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.45); color:#fff; font-size:12px; cursor:pointer; backdrop-filter:blur(6px);
    }

    .page-icon{
      width:78px;height:78px;border-radius:20px;background:#0a0b10;border:1px solid rgba(255,255,255,.1);
      position:relative; margin-top:-39px; margin-inline-start:28px;
      display:grid;place-items:center;font-size:40px; overflow:hidden;
      box-shadow:0 12px 28px rgba(0,0,0,.8);
    }
    [dir="ltr"] .page-icon{margin-inline-start:28px}
    .page-icon img{width:100%;height:100%;object-fit:cover}
    .page-wrap{max-width:900px;margin:0 auto;padding:0 18px 60px;}
    .page-title{
      font-size:38px;font-weight:900;line-height:1.25;margin:8px 0 10px;
      background:transparent;border:0;outline:0;color:var(--text);width:100%;
    }
    .page-props{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-bottom:10px}
    .prop-pill{padding:5px 8px;border-radius:999px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}

    /* Blocks */
    .blocks{display:grid;gap:4px}
    .block{
      display:flex;gap:8px;align-items:flex-start;padding:4px 2px;border-radius:6px;
      border:1px solid transparent;
    }
    .block:hover{background:rgba(255,255,255,.02);border-color:rgba(255,255,255,.04)}
    .handle{
      width:18px; height:18px; border-radius:4px; display:grid; place-items:center; cursor:grab;
      color:var(--muted); font-size:12px; user-select:none; margin-top:4px;
      opacity:.0;
    }
    .block:hover .handle{opacity:.9}
    .block-content{
      flex:1; min-height:20px; outline:0; white-space:pre-wrap; line-height:1.8; font-size:16px;
    }
    .block[data-type="h1"] .block-content{font-size:30px;font-weight:900;line-height:1.3}
    .block[data-type="h2"] .block-content{font-size:24px;font-weight:800}
    .block[data-type="h3"] .block-content{font-size:20px;font-weight:800}
    .block[data-type="quote"]{border-inline-start:3px solid var(--accent); padding-inline-start:8px}
    .block[data-type="callout"]{background:rgba(123,97,255,.08);border-color:rgba(123,97,255,.35)}
    .block[data-type="code"] .block-content{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#0a0b10;border:1px solid rgba(255,255,255,.08); padding:8px;border-radius:8px;
    }
    .todo-box{display:flex; gap:8px; align-items:flex-start}
    .todo-box input{margin-top:5px}

    .slash-menu{
      position:fixed; z-index:9999; background:#0a0b10; border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:6px; width:240px; display:none; box-shadow:0 12px 28px rgba(0,0,0,.9);
    }
    .slash-menu button{
      width:100%; text-align:right; padding:8px; border-radius:8px; cursor:pointer; font-size:13px;
      background:transparent; border:0; color:var(--text); display:flex; justify-content:space-between; align-items:center;
    }
    .slash-menu button:hover{background:rgba(78,161,255,.12)}

    .editor-topbar{
      position:sticky; top:0; z-index:10; background:rgba(0,0,0,.8); backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:8px 10px; display:flex; gap:6px; align-items:center; justify-content:space-between;
    }
    .editor-topbar .left, .editor-topbar .right{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
    .tiny-btn{
      padding:7px 10px; border-radius:9px; border:1px solid rgba(255,255,255,.1);
      background:#0a0b10; color:var(--text); cursor:pointer; font-size:12px;
    }
    .tiny-btn.primary{border-color:rgba(78,161,255,.6);background:rgba(78,161,255,.12)}

  </style>
</head>
<body>
<div class="app" id="app">
  <!-- Sidebar -->
  <aside class="card sidebar">
    <div class="logo">
      <div class="mark">A</div>
      <div>
        <h1>ATLAS Workspace</h1>
        <small>ØµÙ†Ø¹Ù‡ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-sec="home" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© <span>ğŸ </span></button>
      <button data-sec="notes">Ø§Ù„Ù†ÙˆØªØ§Øª <span>ğŸ“</span></button>
      <button data-sec="pdf">Ø£Ø¯ÙˆØ§Øª PDF <span>ğŸ“„</span></button>
      <button data-sec="tracker">Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ… <span>âœ…</span></button>
      <button data-sec="timer">Ù…Ø¤Ù‚Øª <span>â±ï¸</span></button>
    </div>

    <div style="margin-top:10px" class="card">
      <div style="font-weight:800;margin-bottom:6px">Ø§Ù„Ø«ÙŠÙ…</div>
      <div class="theme-row">
        <button class="theme-btn active" data-theme="dark">Dark</button>
        <button class="theme-btn" data-theme="light">Light</button>
        <button class="theme-btn" data-theme="oled">OLED</button>
      </div>
      <div class="hint" style="margin-top:6px">Ø§Ù„Ø«ÙŠÙ… ÙŠÙ†Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
    </div>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="pill" id="greeting">...</div>
    <div class="search">
      ğŸ”
      <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØªØ© / ÙƒÙ„Ù…Ø©..." />
    </div>
    <div class="pill">
      <span class="tag" id="onlineTag">â— ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†</span>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Home -->
    <section class="section active" id="sec-home">
      <div class="home-grid">
        <div class="card welcome">
          <h2 id="welcomeTitle">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
          <p>
            Ù‡Ø°Ø§ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ + Ù†ÙˆØªØ§Øª Ø³ØªØ§ÙŠÙ„ Ù†ÙˆØ´Ù† + Ø£Ø¯ÙˆØ§Øª PDF
            ÙˆÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ø°Ø§ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„Ùƒ.
          </p>
          <div class="quick-cards" style="margin-top:10px">
            <div class="quick">
              <div class="t">Ù†ÙˆØªØ§Øª Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ©</div>
              <div class="s">ØµÙˆØ± + Ø¹Ù†Ø§ÙˆÙŠÙ† + ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ù…Ù„</div>
            </div>
            <div class="quick">
              <div class="t">Ø±ÙˆØªÙŠÙ† ÙŠÙˆÙ…ÙŠ</div>
              <div class="s">Ù…Ø§Ø¡ / Ù†ÙˆÙ… / ØµÙ„Ø§Ø© / Ø¬ÙŠÙ…</div>
            </div>
            <div class="quick">
              <div class="t">PDF Tools</div>
              <div class="s">ØµÙˆØ±â†”PDF / PDFâ†’ØµÙˆØ±</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:800;margin-bottom:8px">Ù„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† ÙŠÙˆÙ…Ùƒ</div>
          <div class="tracker-grid">
            <div class="tracker">
              <div class="row"><div>ğŸ’§ Ø§Ù„Ù…Ø§Ø¡</div><div class="small" id="w-water">0 ÙƒÙˆØ¨</div></div>
              <div class="counter">
                <button data-track="water" data-delta="-1">-</button>
                <input id="in-water" type="number" min="0" value="0"/>
                <button data-track="water" data-delta="1">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸŒ™ Ø§Ù„Ù†ÙˆÙ…</div><div class="small" id="w-sleep">0 Ø³Ø§Ø¹Ø©</div></div>
              <div class="counter">
                <button data-track="sleep" data-delta="-0.5">-</button>
                <input id="in-sleep" type="number" min="0" step="0.5" value="0"/>
                <button data-track="sleep" data-delta="0.5">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸ•Œ Ø§Ù„ØµÙ„Ø§Ø©</div><div class="small" id="w-prayer">0 / 5</div></div>
              <div class="counter">
                <button data-track="prayer" data-delta="-1">-</button>
                <input id="in-prayer" type="number" min="0" max="5" value="0"/>
                <button data-track="prayer" data-delta="1">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸ‹ï¸ Ø§Ù„Ø¬ÙŠÙ…</div><div class="small" id="w-gym">0 Ø¯Ù‚ÙŠÙ‚Ø©</div></div>
              <div class="counter">
                <button data-track="gym" data-delta="-10">-</button>
                <input id="in-gym" type="number" min="0" step="10" value="0"/>
                <button data-track="gym" data-delta="10">+</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn primary" id="saveTracker">Ø­ÙØ¸ Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</button>
            <button class="btn" id="goTracker">Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØªÙŠÙ†</button>
          </div>
          <div class="hint">Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ø±ÙˆØªÙŠÙ† ÙŠÙ†Ø­ÙØ¸ Ø¹Ù†Ø¯Ùƒ ÙŠÙˆÙ…ÙŠØ§Ù‹.</div>
        </div>
      </div>
    </section>

    <!-- Notes -->
    
<section class="section" id="sec-notes">
  <div class="notion-shell">

    <!-- Notion Sidebar -->
    <aside class="notion-side">
      <div class="notion-user">
        <div class="uava" id="notionAvatar">A</div>
        <div style="display:grid;gap:2px">
          <div style="font-weight:800" id="notionUserName">Ø¶ÙŠÙ</div>
          <div class="small" id="notionUserEmail">â€”</div>
        </div>
      </div>

      <div class="notion-search">
        ğŸ” <input id="notionSearch" placeholder="Search" />
      </div>

      <div class="side-section">
        <div class="side-item active" data-filter="all"><span class="dot">ğŸ“„</span><span>All Pages</span></div>
        <div class="side-item" data-filter="fav"><span class="dot">â­</span><span>Favorites</span></div>
        <div class="side-item" data-filter="private"><span class="dot">ğŸ”’</span><span>Private</span></div>
        <div class="side-item" data-filter="shared"><span class="dot">ğŸ‘¥</span><span>Shared</span></div>
        <div class="side-item" data-filter="trash"><span class="dot">ğŸ—‘ï¸</span><span>Trash</span></div>
      </div>

      <div class="side-title">Pages</div>
      <div class="page-list" id="pageList"></div>

      <div class="side-section" style="margin-top:6px">
        <button class="tiny-btn primary" id="newPageBtn">+ New page</button>
      </div>

      <div class="side-section">
        <div class="side-title">Settings</div>
        <div class="side-item" id="notesSettingsBtn"><span class="dot">âš™ï¸</span><span>Notes Settings</span></div>
      </div>
    </aside>

    <!-- Editor -->
    <section class="notion-editor">
      <div class="editor-topbar">
        <div class="left">
          <button class="tiny-btn" id="backToList">â˜°</button>
          <button class="tiny-btn" id="toggleFavBtn">â­</button>
          <button class="tiny-btn" id="shareBtn">ğŸ”— Share</button>
        </div>
        <div class="right">
          <button class="tiny-btn" id="undoBtn">â†¶</button>
          <button class="tiny-btn" id="redoBtn">â†·</button>
          <button class="tiny-btn primary" id="savePageBtn">Save</button>
          <button class="tiny-btn" id="deletePageBtn">Delete</button>
        </div>
      </div>

      <div class="page-cover" id="pageCover">
        <div class="cover-actions">
          <button class="mini" id="changeCoverBtn">Change cover</button>
          <button class="mini" id="removeCoverBtn">Remove</button>
        </div>
        <div class="small" id="coverHint">Click to add cover</div>
        <input id="coverFile" type="file" accept="image/*" style="display:none">
      </div>

      <div class="page-wrap">
        <div class="page-icon" id="pageIcon">ğŸ“
          <input id="iconFile" type="file" accept="image/*" style="display:none">
        </div>

        <input class="page-title" id="pageTitle" placeholder="Untitled" />

        <div class="page-props">
          <div class="prop-pill">ğŸ“… <span id="pageDate">â€”</span></div>
          <div class="prop-pill">ğŸ•’ <span id="pageTime">â€”</span></div>
        </div>

        <div class="blocks" id="blocks"></div>
        <div class="hint" style="margin-top:10px">Ø§ÙƒØªØ¨ / Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª. Ø§Ø³Ø­Ø¨ â‹®â‹® Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨.</div>
      </div>
    </section>
  </div>

  <!-- Slash menu -->
  <div class="slash-menu" id="slashMenu">
    <button data-type="text">Text <span>T</span></button>
    <button data-type="h1">Heading 1 <span>H1</span></button>
    <button data-type="h2">Heading 2 <span>H2</span></button>
    <button data-type="h3">Heading 3 <span>H3</span></button>
    <button data-type="bullet">Bulleted list <span>â€¢</span></button>
    <button data-type="number">Numbered list <span>1.</span></button>
    <button data-type="todo">Toâ€‘do list <span>â˜‘</span></button>
    <button data-type="toggle">Toggle list <span>â–¸</span></button>
    <button data-type="quote">Quote <span>â</span></button>
    <button data-type="callout">Callout <span>ğŸ’¡</span></button>
    <button data-type="divider">Divider <span>â€”</span></button>
    <button data-type="code">Code <span>{ }</span></button>
    <button data-type="columns">2 Columns <span>â«¶</span></button>
  </div>
</section>


    <!-- PDF Tools -->
    <section class="section" id="sec-pdf">
      <div class="card">
        <div style="font-weight:900;font-size:18px;margin-bottom:10px">Ø£Ø¯ÙˆØ§Øª PDF Ø¯Ø§Ø®Ù„ ATLAS</div>
        <div class="pdf-grid">

          <!-- Images to PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ–¼ï¸ ØµÙˆØ± â†’ PDF</div>
            <div class="drop">
              <label for="imgToPdfInput">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</label>
              <input id="imgToPdfInput" type="file" accept="image/*" multiple>
              <div class="small" id="imgToPdfCount">0 ØµÙˆØ±</div>
            </div>
            <button class="btn primary" id="imgToPdfBtn">Ø­ÙˆÙ‘Ù„</button>
            <div class="hint">ÙŠØ¯Ø¹Ù… ØµÙˆØ± Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆÙŠØ¹Ø·ÙŠÙƒ Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯.</div>
          </div>

          <!-- PDF to Images -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“„ PDF â†’ ØµÙˆØ±</div>
            <div class="drop">
              <label for="pdfToImgInput">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF</label>
              <input id="pdfToImgInput" type="file" accept="application/pdf">
              <div class="small" id="pdfToImgName">---</div>
            </div>
            <button class="btn primary" id="pdfToImgBtn">Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØ±</button>
            <div class="hint">ÙŠØ­ÙˆÙ„ ØµÙØ­Ø§Øª PDF Ø¥Ù„Ù‰ PNG (Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰).</div>
          </div>

          <!-- PPTX to PDF Placeholder -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“Š PowerPoint â†’ PDF</div>
            <div class="drop">
              <div class="small">Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„ PPTX Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯Ù‚Ø© 100%.</div>
            </div>
            <a class="btn primary" target="_blank"
              href="https://www.ilovepdf.com/powerpoint_to_pdf">
              Ø§ÙØªØ­ Ù…Ø­ÙˆÙ„ Ø®Ø§Ø±Ø¬ÙŠ
            </a>
            <div class="hint">Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ù†Ø¶ÙŠÙ Ø³ÙŠØ±ÙØ± ØµØºÙŠØ± ÙˆÙŠØ­ÙˆÙ„Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.</div>
          </div>

        </div>
      </div>
    </section>

    <!-- Tracker page -->
    <section class="section" id="sec-tracker">
      <div class="card">
        <div style="font-weight:900;font-size:18px;margin-bottom:8px">Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ… âœ…</div>
        <div class="tracker-grid">

          <div class="tracker">
            <div class="row"><div>ğŸ’§ Ø§Ù„Ù…Ø§Ø¡</div><div class="small" id="t-water">0 ÙƒÙˆØ¨</div></div>
            <div class="counter">
              <button data-track="water" data-delta="-1">-</button>
              <input id="t-in-water" type="number" min="0" value="0"/>
              <button data-track="water" data-delta="1">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸŒ™ Ø§Ù„Ù†ÙˆÙ…</div><div class="small" id="t-sleep">0 Ø³Ø§Ø¹Ø©</div></div>
            <div class="counter">
              <button data-track="sleep" data-delta="-0.5">-</button>
              <input id="t-in-sleep" type="number" min="0" step="0.5" value="0"/>
              <button data-track="sleep" data-delta="0.5">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸ•Œ Ø§Ù„ØµÙ„Ø§Ø©</div><div class="small" id="t-prayer">0 / 5</div></div>
            <div class="counter">
              <button data-track="prayer" data-delta="-1">-</button>
              <input id="t-in-prayer" type="number" min="0" max="5" value="0"/>
              <button data-track="prayer" data-delta="1">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸ‹ï¸ Ø§Ù„Ø¬ÙŠÙ…</div><div class="small" id="t-gym">0 Ø¯Ù‚ÙŠÙ‚Ø©</div></div>
            <div class="counter">
              <button data-track="gym" data-delta="-10">-</button>
              <input id="t-in-gym" type="number" min="0" step="10" value="0"/>
              <button data-track="gym" data-delta="10">+</button>
            </div>
          </div>

        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="saveTracker2">Ø­ÙØ¸</button>
          <button class="btn" id="loadTracker2">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
      </div>
    </section>

    <!-- Timer -->
    <section class="section" id="sec-timer">
      <div class="timer-wrap">
        <div class="card">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px">â±ï¸ Ù…Ø¤Ù‚Øª / Pomodoro</div>
          <div class="timer-display" id="timerDisplay">25:00</div>
          <div class="timer-controls">
            <button class="btn primary" id="startTimer">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn" id="pauseTimer">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
            <button class="btn" id="resetTimer">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>
        <div class="card">
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn" data-preset="25">Pomodoro 25</button>
            <button class="btn" data-preset="50">Focus 50</button>
            <button class="btn" data-preset="10">Break 10</button>
          </div>
          <div class="field" style="margin-top:10px">
            <label>Ù…Ø¯Ø© Ù…Ø®ØµØµØ© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="customMinutes" type="number" min="1" value="25"/>
          </div>
          <button class="btn primary" id="applyCustom" style="margin-top:8px">ØªØ·Ø¨ÙŠÙ‚</button>
          <div class="hint">Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø³ÙŠØ· ÙˆØ¹Ù…Ù„ÙŠ Ù„Ø±ÙˆØªÙŠÙ†Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Profile -->
  <aside class="card profile">
    <div class="profile-head">
      <div class="avatar" id="avatarBox">A</div>
      <div>
        <div style="font-weight:800" id="userName">Ø¶ÙŠÙ</div>
        <div class="small" id="userEmail">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
      </div>
    </div>

    <div class="profile-actions">
      <button class="btn primary" id="googleLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google</button>
      <button class="btn" id="guestMode">Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ¶ÙŠÙ</button>
      <button class="btn danger" id="logoutBtn" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      <button class="btn" id="editProfileBtn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>

    <div style="margin-top:10px" class="card">
      <div style="font-weight:800;margin-bottom:6px">Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</div>
      <div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØªØ§Øª: <span id="statNotes">0</span></div>
      <div class="small">Ø¢Ø®Ø± Ø­ÙØ¸: <span id="statLast">â€”</span></div>
    </div>

    <div style="margin-top:10px" class="hint">
      ATLAS Workspace â€” Ù…Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„Ù…ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ§Ù„Ù†ÙˆØªØ§Øª ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„Ø­ÙŠØ§Ø©.
    </div>
  </aside>

  <footer class="footer">
    Â© ATLAS Workspace â€” ØµÙ†Ø¹Ù‡ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ
  </footer>
</div>

<!-- Modal Profile -->
<div class="modal" id="profileModal">
  <div class="box">
    <div style="font-weight:900;font-size:18px">ØªØ®ØµÙŠØµ Ø§Ø³Ù…Ùƒ</div>
    <div class="field">
      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="profileNameInput" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯"/>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeProfileModal">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn primary" id="saveProfileModal">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Emoji prompt -->
<div class="modal" id="emojiModal">
  <div class="box">
    <div style="font-weight:900;font-size:18px">Ø§Ø®ØªØ± Emoji Ù„Ù„Ù†ÙˆØªØ©</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;font-size:22px">
      <button class="tool em">ğŸ˜€</button><button class="tool em">âœ¨</button><button class="tool em">ğŸ“Œ</button>
      <button class="tool em">ğŸ”¥</button><button class="tool em">ğŸŒ™</button><button class="tool em">ğŸ’¡</button>
      <button class="tool em">âœ…</button><button class="tool em">ğŸ“š</button><button class="tool em">ğŸ®</button>
      <button class="tool em">ğŸ‹ï¸</button><button class="tool em">ğŸ§ </button><button class="tool em">â¤ï¸</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeEmoji">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Firebase compat CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.mjs" type="module"></script>

<script>
/* ==============================
   ATLAS Workspace â€” Single file
   by Mahmoud Smadi
================================ */

// ------- Firebase Config (your keys) ------
const firebaseConfig = {
  apiKey: "AIzaSyCIFmF0UM4D0A0abndus2gYAZowiMMsbps",
  authDomain: "planning-with-ai-6c537.firebaseapp.com",
  projectId: "planning-with-ai-6c537",
  storageBucket: "planning-with-ai-6c537.firebasestorage.app",
  messagingSenderId: "134752053062",
  appId: "1:134752053062:web:808fa5434a0d445dd12747"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const storage = firebase.storage();

// ------- State ------
let currentUser = null;
let notes = [];
let currentNoteId = null;
let currentEmoji = "ğŸ“";
let currentCoverURL = "";
let isGuest = true;

// ------- Helpers ------
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);

const todayKey = ()=>{
  const d=new Date();
  return d.toISOString().slice(0,10);
};
const niceDate = (ts)=>{
  try{
    const d = ts?.toDate ? ts.toDate() : (ts? new Date(ts): new Date());
    return d.toLocaleString("ar",{hour12:true});
  }catch{return "â€”"}
};

function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("atlas-theme", theme);
  $$(".theme-btn").forEach(b=>b.classList.toggle("active", b.dataset.theme===theme));
  if(currentUser && !isGuest){
    db.collection("users").doc(currentUser.uid).set({theme},{merge:true});
  }
}
(function initTheme(){
  const t = localStorage.getItem("atlas-theme") || "oled";
  setTheme(t);
})();

// ------- Nav / Sections ------
$("#nav").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-sec]");
  if(!btn) return;
  const sec = btn.dataset.sec;

  $$("#nav button").forEach(b=>b.classList.toggle("active", b===btn));
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-"+sec).classList.add("active");
});

// ------- Greeting ------
function updateGreeting(name=""){
  const h = new Date().getHours();
  const g = h<12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±" : (h<18 ? "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±");
  $("#greeting").textContent = `${g} ${name? "ÙŠØ§ "+name : ""} ğŸŒ™`;
  $("#welcomeTitle").textContent = `${g} ${name? name : ""} ğŸ‘‹`;
}

// ------- Auth UI ------
async function signInGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
}
async function signOut(){
  await auth.signOut();
}

$("#googleLogin").onclick = signInGoogle;
$("#logoutBtn").onclick = signOut;
$("#guestMode").onclick = ()=>{
  isGuest = true;
  currentUser = null;
  setUserUI();
  loadLocalNotes();
  loadLocalTracker();
};

auth.onAuthStateChanged(async(user)=>{
  if(user){
    currentUser = user;
    isGuest = false;
    await loadUserProfile();
    await loadNotes();
    await loadTracker();
  }else{
    currentUser = null;
    isGuest = true;
    loadLocalNotes();
    loadLocalTracker();
  }
  setUserUI();
});

async function loadUserProfile(){
  const ref = db.collection("users").doc(currentUser.uid);
  const snap = await ref.get();
  const data = snap.exists ? snap.data() : {};
  const name = data.name || currentUser.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
  updateGreeting(name);
  $("#userName").textContent = name;
  $("#profileNameInput").value = name;
  if(data.theme) setTheme(data.theme);
}

function setUserUI(){
  if(currentUser && !isGuest){
    $("#userName").textContent = currentUser.displayName || $("#userName").textContent;
    $("#userEmail").textContent = currentUser.email || "";
    $("#logoutBtn").style.display="inline-block";
    $("#googleLogin").style.display="none";
    $("#guestMode").style.display="none";
    const photo = currentUser.photoURL;
    if(photo){
      $("#avatarBox").innerHTML = `<img src="${photo}">`;
    }else{
      $("#avatarBox").textContent = (currentUser.displayName||"A").slice(0,1).toUpperCase();
    }
  }else{
    $("#userName").textContent = "Ø¶ÙŠÙ";
    $("#userEmail").textContent = "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ";
    $("#logoutBtn").style.display="none";
    $("#googleLogin").style.display="inline-block";
    $("#guestMode").style.display="inline-block";
    $("#avatarBox").textContent="A";
    updateGreeting("");
  }
}

// ------- Profile modal ------
$("#editProfileBtn").onclick=()=>$("#profileModal").classList.add("active");
$("#closeProfileModal").onclick=()=>$("#profileModal").classList.remove("active");
$("#saveProfileModal").onclick=async()=>{
  const name = $("#profileNameInput").value.trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
  $("#profileModal").classList.remove("active");
  updateGreeting(name);
  $("#userName").textContent = name;
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid).set({name},{merge:true});
  }else{
    localStorage.setItem("atlas-guest-name", name);
  }
};

// restore guest name
(function(){
  const n = localStorage.getItem("atlas-guest-name");
  if(n) updateGreeting(n);
})();

// ------- Theme buttons ------
$$(".theme-btn").forEach(b=>{
  b.onclick=()=>setTheme(b.dataset.theme);
});

// ------- Tracker -------
let trackerState = {water:0,sleep:0,prayer:0,gym:0};

function syncTrackerInputs(){
  const map = [
    ["water","in-water","w-water","t-in-water","t-water"," ÙƒÙˆØ¨"],
    ["sleep","in-sleep","w-sleep","t-in-sleep","t-sleep"," Ø³Ø§Ø¹Ø©"],
    ["prayer","in-prayer","w-prayer","t-in-prayer","t-prayer"," / 5"],
    ["gym","in-gym","w-gym","t-in-gym","t-gym"," Ø¯Ù‚ÙŠÙ‚Ø©"]
  ];
  map.forEach(([k,a,b,c,d,suf])=>{
    if($("#"+a)) $("#"+a).value = trackerState[k];
    if($("#"+c)) $("#"+c).value = trackerState[k];
    if($("#"+b)) $("#"+b).textContent = trackerState[k]+suf;
    if($("#"+d)) $("#"+d).textContent = trackerState[k]+suf;
  });
}

document.body.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-track]");
  if(!btn) return;
  const k = btn.dataset.track;
  const delta = parseFloat(btn.dataset.delta);
  trackerState[k] = Math.max(0, (trackerState[k]||0) + delta);
  if(k==="prayer") trackerState[k]=Math.min(5, trackerState[k]);
  syncTrackerInputs();
});

$("#saveTracker").onclick=saveTracker;
$("#saveTracker2").onclick=saveTracker;
$("#loadTracker2").onclick=loadTracker;
$("#goTracker").onclick=()=>{
  $$("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.sec==="tracker"));
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-tracker").classList.add("active");
};

async function saveTracker(){
  const key = todayKey();
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid)
      .collection("trackers").doc(key)
      .set({...trackerState, updatedAt: Date.now()},{merge:true});
  }else{
    localStorage.setItem("atlas-tracker-"+key, JSON.stringify(trackerState));
  }
}

async function loadTracker(){
  const key = todayKey();
  if(currentUser && !isGuest){
    const doc = await db.collection("users").doc(currentUser.uid)
      .collection("trackers").doc(key).get();
    trackerState = doc.exists ? doc.data() : trackerState;
  }else{
    const j = localStorage.getItem("atlas-tracker-"+key);
    if(j) trackerState = JSON.parse(j);
  }
  syncTrackerInputs();
}
function loadLocalTracker(){ loadTracker(); }

// ------- Notes -------
// (Replaced by Notion-style editor)
// ------- Toolbar formatting -------

// ===== Notion-style Notes Editor =====
let notionNotes = [];
let notionCurrentId = null;
let notionFilter = "all";

function loadNotionNotes(){
  if(currentUser && !isGuest){
    // reuse firestore user notes collection
    return db.collection("users").doc(currentUser.uid).collection("notes")
      .orderBy("updatedAt","desc").get()
      .then(snap=>{
        notionNotes = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderPageList();
        if(notionNotes[0]) openPage(notionNotes[0].id);
      });
  }else{
    const j = localStorage.getItem("atlas-guest-notes");
    notionNotes = j? JSON.parse(j): [];
    renderPageList();
    if(notionNotes[0]) openPage(notionNotes[0].id);
  }
}

function saveNotionNotesLocal(){
  localStorage.setItem("atlas-guest-notes", JSON.stringify(notionNotes));
}

function renderPageList(){
  const host=$("#pageList"); if(!host) return;
  const q=($("#notionSearch")?.value||"").trim().toLowerCase();
  host.innerHTML="";
  const filtered = notionNotes.filter(n=>{
    if(n.isTrash) return notionFilter==="trash";
    if(notionFilter==="fav" && !n.isFavorite) return false;
    if(notionFilter==="private" && (n.visibility||"private")!=="private") return false;
    if(notionFilter==="shared" && (n.visibility||"private")!=="shared") return false;
    if(notionFilter==="trash" && !n.isTrash) return false;
    if(q){
      return (n.title||"").toLowerCase().includes(q) || (n.contentHTML||"").toLowerCase().includes(q);
    }
    return true;
  });

  filtered.forEach(n=>{
    const row=document.createElement("div");
    row.className="page-row"+(n.id===notionCurrentId?" active":"");
    const icon = n.iconURL ? `<img src="${n.iconURL}" style="width:18px;height:18px;border-radius:4px;object-fit:cover">`
                           : (n.emoji||"ğŸ“");
    row.innerHTML=`<div>${icon}</div><div style="flex:1">${n.title||"Untitled"}</div>${n.isFavorite?'<div class="fav">â­</div>':''}`;
    row.onclick=()=>openPage(n.id);
    host.appendChild(row);
  });

  $("#statNotes") && ($("#statNotes").textContent = notionNotes.filter(n=>!n.isTrash).length);
}

function setNotionUserUI(){
  const name = (currentUser && !isGuest) ? (currentUser.displayName||"User") : "Ø¶ÙŠÙ";
  const email= (currentUser && !isGuest) ? (currentUser.email||"") : "Guest mode";
  $("#notionUserName") && ($("#notionUserName").textContent=name);
  $("#notionUserEmail") && ($("#notionUserEmail").textContent=email);
  const ava=$("#notionAvatar");
  if(ava){
    if(currentUser?.photoURL){
      ava.innerHTML=`<img src="${currentUser.photoURL}">`;
    }else{
      ava.textContent=(name||"A").slice(0,1).toUpperCase();
    }
  }
}

function newPage(){
  notionCurrentId=null;
  $("#pageTitle").value="";
  setCover("");
  setIcon("", "ğŸ“");
  $("#blocks").innerHTML="";
  addBlock("text","");
  updatePageProps(Date.now());
}

function openPage(id){
  const n = notionNotes.find(x=>x.id===id);
  if(!n) return;
  notionCurrentId=id;
  $("#pageTitle").value=n.title||"";
  setCover(n.coverURL||"");
  setIcon(n.iconURL||"", n.emoji||"ğŸ“");
  $("#blocks").innerHTML=n.contentHTML||"";
  bindBlocks();
  if(!$("#blocks .block")) addBlock("text","");
  updatePageProps(n.updatedAt||n.createdAt||Date.now());
  $("#toggleFavBtn").textContent=n.isFavorite?"â­ Favorited":"â­ Favorite";
  renderPageList();
}

async function savePage(){
  const title=$("#pageTitle").value.trim();
  const contentHTML=$("#blocks").innerHTML.trim();
  const payload={
    title,
    contentHTML,
    emoji: $("#pageIcon").dataset.emoji||"ğŸ“",
    iconURL: $("#pageIcon").dataset.icon||"",
    coverURL: $("#pageCover").dataset.cover||"",
    isFavorite: $("#toggleFavBtn").dataset.fav==="1",
    visibility: "private",
    isTrash:false,
    updatedAt: Date.now(),
    createdAt: notionCurrentId? undefined: Date.now()
  };

  if(currentUser && !isGuest){
    const ref = notionCurrentId
      ? db.collection("users").doc(currentUser.uid).collection("notes").doc(notionCurrentId)
      : db.collection("users").doc(currentUser.uid).collection("notes").doc();
    if(!notionCurrentId) notionCurrentId=ref.id;
    await ref.set(payload,{merge:true});
    await loadNotionNotes();
  }else{
    if(notionCurrentId){
      const idx=notionNotes.findIndex(n=>n.id===notionCurrentId);
      notionNotes[idx]={...notionNotes[idx],...payload};
    }else{
      notionCurrentId="g_"+Date.now();
      notionNotes.unshift({id:notionCurrentId,...payload});
    }
    await saveNotionNotesLocal();
    renderPageList();
  }
  $("#statLast") && ($("#statLast").textContent=niceDate(Date.now()));
}

async function deletePage(){
  if(!notionCurrentId) return;
  const n=notionNotes.find(x=>x.id===notionCurrentId); if(!n) return;
  if(!confirm("Delete page?")) return;
  n.isTrash=true;
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid).collection("notes").doc(notionCurrentId).set({isTrash:true},{merge:true});
    await loadNotionNotes();
  }else{
    await saveNotionNotesLocal();
    renderPageList();
  }
  newPage();
}

// Cover/Icon
function setCover(url){
  const box=$("#pageCover"); if(!box) return;
  box.dataset.cover=url||"";
  if(url){
    box.innerHTML=`<img src="${url}"><div class="cover-actions">
      <button class="mini" id="changeCoverBtn">Change cover</button>
      <button class="mini" id="removeCoverBtn">Remove</button>
    </div><input id="coverFile" type="file" accept="image/*" style="display:none">`;
  }else{
    box.innerHTML=`<div class="cover-actions">
      <button class="mini" id="changeCoverBtn">Change cover</button>
      <button class="mini" id="removeCoverBtn">Remove</button>
    </div><div class="small" id="coverHint">Click to add cover</div>
    <input id="coverFile" type="file" accept="image/*" style="display:none">`;
  }
  bindCoverIconHandlers();
}
function setIcon(url, emoji){
  const box=$("#pageIcon"); if(!box) return;
  box.dataset.icon=url||"";
  box.dataset.emoji=emoji||"ğŸ“";
  if(url){
    box.innerHTML=`<img src="${url}"><input id="iconFile" type="file" accept="image/*" style="display:none">`;
  }else{
    box.textContent=emoji||"ğŸ“";
    box.innerHTML += `<input id="iconFile" type="file" accept="image/*" style="display:none">`;
  }
  bindCoverIconHandlers();
}
function bindCoverIconHandlers(){
  const coverFile=$("#coverFile"), iconFile=$("#iconFile");
  $("#pageCover")?.addEventListener("click",(e)=>{
    if(e.target.closest(".cover-actions")) return;
    coverFile?.click();
  });
  $("#changeCoverBtn")?.addEventListener("click",(e)=>{e.stopPropagation(); coverFile?.click();});
  $("#removeCoverBtn")?.addEventListener("click",(e)=>{e.stopPropagation(); setCover("");});
  coverFile && (coverFile.onchange=async(e)=>{
    const file=e.target.files[0]; if(!file) return;
    let url="";
    if(currentUser && !isGuest){
      const path=`covers/${currentUser.uid}/${Date.now()}_${file.name}`;
      const task=await storage.ref(path).put(file);
      url=await task.ref.getDownloadURL();
    }else{
      url=await fileToDataURL(file);
    }
    setCover(url);
  });

  $("#pageIcon")?.addEventListener("click",(e)=>{
    e.stopPropagation(); iconFile?.click();
  });
  iconFile && (iconFile.onchange=async(e)=>{
    const file=e.target.files[0]; if(!file) return;
    let url="";
    if(currentUser && !isGuest){
      const path=`note-icons/${currentUser.uid}/${Date.now()}_${file.name}`;
      const task=await storage.ref(path).put(file);
      url=await task.ref.getDownloadURL();
    }else{
      url=await fileToDataURL(file);
    }
    setIcon(url, $("#pageIcon").dataset.emoji||"ğŸ“");
  });
}

// Props
function updatePageProps(ts){
  const d=new Date(ts);
  $("#pageDate").textContent=d.toLocaleDateString(currentLang==="en"?"en":"ar");
  $("#pageTime").textContent=d.toLocaleTimeString(currentLang==="en"?"en":"ar");
}

// Blocks
function createBlock(type="text", html=""){
  const div=document.createElement("div");
  div.className="block";
  div.draggable=true;
  div.dataset.type=type;
  div.innerHTML=`<div class="handle">â‹®â‹®</div><div class="block-content" contenteditable="true"></div>`;
  const content=div.querySelector(".block-content");
  if(type==="divider"){
    content.contentEditable="false";
    content.innerHTML="<hr style='border:0;border-top:1px solid rgba(255,255,255,.1)'>";
  }else if(type==="todo"){
    content.innerHTML=`<label class="todo-box"><input type="checkbox"> <span contenteditable="true">${html||""}</span></label>`;
  }else if(type==="toggle"){
    content.innerHTML=`<details><summary contenteditable="true">${html||"Toggle"}</summary><div contenteditable="true" style="margin-top:6px">...</div></details>`;
  }else if(type==="columns"){
    content.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div contenteditable="true" style="min-height:40px;padding:6px;border:1px dashed rgba(255,255,255,.08);border-radius:8px"></div>
      <div contenteditable="true" style="min-height:40px;padding:6px;border:1px dashed rgba(255,255,255,.08);border-radius:8px"></div>
    </div>`;
  }else{
    content.innerHTML=html||"";
  }
  return div;
}
function addBlock(type="text", html=""){
  const host=$("#blocks");
  const b=createBlock(type, html);
  host.appendChild(b);
  bindBlock(b);
  focusBlock(b);
  return b;
}
function focusBlock(b){
  const c=b.querySelector(".block-content [contenteditable='true']") || b.querySelector(".block-content");
  c?.focus();
  placeCaretAtEnd(c);
}
function placeCaretAtEnd(el){
  try{
    const range=document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel=window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch{}
}

let slashTarget=null;
function showSlashMenu(x,y,target){
  const menu=$("#slashMenu"); if(!menu) return;
  slashTarget=target;
  menu.style.display="block";
  menu.style.left=x+"px"; menu.style.top=y+"px";
}
function hideSlashMenu(){
  const menu=$("#slashMenu"); if(menu) menu.style.display="none";
  slashTarget=null;
}
$("#slashMenu")?.addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-type]"); if(!btn||!slashTarget) return;
  const type=btn.dataset.type;
  slashTarget.dataset.type=type;
  const content=slashTarget.querySelector(".block-content");
  // reset inner structure
  const oldText=content?.innerText||"";
  slashTarget.replaceWith(createBlock(type, oldText));
  bindBlocks();
  hideSlashMenu();
});

function bindBlock(b){
  const content=b.querySelector(".block-content");
  content.addEventListener("keydown",(e)=>{
    // Enter -> new block
    if(e.key==="Enter" && !e.shiftKey){
      // avoid enter inside details/columns/code or checkbox span
      if(e.target.closest("details") || b.dataset.type==="code" || b.dataset.type==="columns") return;
      e.preventDefault();
      const nb=addBlock("text","");
      return;
    }
    // Slash menu
    if(e.key==="/" ){
      setTimeout(()=>{
        const rect=b.getBoundingClientRect();
        showSlashMenu(rect.left+20, rect.top+30, b);
      },0);
    }
    // Backspace on empty block -> remove
    if(e.key==="Backspace"){
      const t=(content.innerText||"").trim();
      if(!t && $("#blocks").children.length>1){
        e.preventDefault();
        const prev=b.previousElementSibling;
        b.remove();
        if(prev) focusBlock(prev);
        return;
      }
    }
  });

  // drag
  b.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain", b.dataset.id||"");
    b.classList.add("dragging");
  });
  b.addEventListener("dragend",()=>b.classList.remove("dragging"));
}
function bindBlocks(){
  const host=$("#blocks");
  host.querySelectorAll(".block").forEach(b=>bindBlock(b));
  // drag over
  host.ondragover=(e)=>{
    e.preventDefault();
    const dragging=host.querySelector(".dragging");
    const after=getDragAfterElement(host, e.clientY);
    if(after==null) host.appendChild(dragging);
    else host.insertBefore(dragging, after);
  };
}
function getDragAfterElement(container, y){
  const els=[...container.querySelectorAll(".block:not(.dragging)")];
  return els.reduce((closest, child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset) return {offset, element:child};
    return closest;
  }, {offset:Number.NEGATIVE_INFINITY}).element;
}

document.addEventListener("click",(e)=>{
  if(!e.target.closest("#slashMenu")) hideSlashMenu();
});

// Buttons & events
$("#newPageBtn")?.addEventListener("click", newPage);
$("#savePageBtn")?.addEventListener("click", savePage);
$("#deletePageBtn")?.addEventListener("click", deletePage);
$("#notionSearch")?.addEventListener("input", renderPageList);

document.querySelectorAll(".side-item[data-filter]").forEach(it=>{
  it.addEventListener("click", ()=>{
    document.querySelectorAll(".side-item[data-filter]").forEach(x=>x.classList.remove("active"));
    it.classList.add("active");
    notionFilter=it.dataset.filter;
    renderPageList();
  });
});

$("#toggleFavBtn")?.addEventListener("click", ()=>{
  const n=notionNotes.find(x=>x.id===notionCurrentId);
  const now=!(n?.isFavorite);
  $("#toggleFavBtn").dataset.fav= now?"1":"0";
  $("#toggleFavBtn").textContent=now?"â­ Favorited":"â­ Favorite";
  if(n){ n.isFavorite=now; (currentUser&&!isGuest) && db.collection("users").doc(currentUser.uid).collection("notes").doc(notionCurrentId).set({isFavorite:now},{merge:true}); saveNotionNotesLocal(); renderPageList();}
});

// Simple undo/redo (native execCommand)
$("#undoBtn")?.addEventListener("click",()=>document.execCommand("undo"));
$("#redoBtn")?.addEventListener("click",()=>document.execCommand("redo"));

// When entering notes section, init notion notes
function enterNotesMode(){
  document.body.classList.add("notes-mode");
  setNotionUserUI();
  loadNotionNotes();
}
function leaveNotesMode(){
  document.body.classList.remove("notes-mode");
}

// Hook nav to notes-mode
const _oldNavHandler = $("#nav")?.onclick;
$("#nav")?.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-sec]");
  if(!btn) return;
  if(btn.dataset.sec==="notes") enterNotesMode();
  else leaveNotesMode();
});

// Also react to auth changes
auth.onAuthStateChanged((u)=>{
  setNotionUserUI();
  if(document.body.classList.contains("notes-mode")) loadNotionNotes();
});

$$(".tool[data-cmd]").forEach(b=>{
  b.onclick=()=>{
    const cmd=b.dataset.cmd;
    const arg=b.dataset.arg||null;
    document.execCommand(cmd,false,arg);
    $("#noteContent").focus();
  };
});
$("#fontFamily").onchange=()=>{
  $("#noteContent").style.fontFamily=$("#fontFamily").value;
};
$("#fontSize").onchange=()=>{
  $("#noteContent").style.fontSize=$("#fontSize").value+"px";
};
$("#fontColor").onchange=()=>{
  $("#noteContent").style.color=$("#fontColor").value;
};

// ------- Emoji -------
$("#pickEmoji").onclick=()=>$("#emojiModal").classList.add("active");
$("#closeEmoji").onclick=()=>$("#emojiModal").classList.remove("active");
$$(".em").forEach(btn=>{
  btn.onclick=()=>{
    currentEmoji = btn.textContent.trim();
    $("#emojiModal").classList.remove("active");
    renderNotesList($("#searchInput").value.trim().toLowerCase());
  };
});

// ------- Cover handlers -------
function bindCoverHandlers(){
  const coverBox=$("#coverBox");
  const coverInput=$("#coverInput");
  if(!coverBox||!coverInput) return;

  coverBox.onclick=()=>coverInput.click();
  coverInput.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    if(currentUser && !isGuest){
      const path=`covers/${currentUser.uid}/${Date.now()}_${file.name}`;
      const task=await storage.ref(path).put(file);
      currentCoverURL=await task.ref.getDownloadURL();
    }else{
      currentCoverURL=await fileToDataURL(file);
    }
    renderCover(currentCoverURL);
  };
  $("#removeCover").onclick=(ev)=>{
    ev.stopPropagation();
    currentCoverURL="";
    renderCover("");
  };
}
bindCoverHandlers();

function renderCover(url){
  const box=$("#coverBox");
  if(!box) return;
  if(url){
    box.innerHTML=`<img src="${url}"><input type="file" id="coverInput" accept="image/*" style="display:none">
      <div class="cover-actions"><button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button></div>`;
  }else{
    box.innerHTML=`<div>Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Cover</div><input type="file" id="coverInput" accept="image/*" style="display:none">
      <div class="cover-actions"><button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button></div>`;
  }
  bindCoverHandlers();
}
$("#setCoverBtn").onclick=()=>$("#coverInput")?.click();

// inline image
$("#addImageInline").onclick=()=>$("#inlineImageInput").click();
$("#inlineImageInput").onchange=async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  let url="";
  if(currentUser && !isGuest){
    const path=`note-images/${currentUser.uid}/${Date.now()}_${file.name}`;
    const task=await storage.ref(path).put(file);
    url=await task.ref.getDownloadURL();
  }else{
    url=await fileToDataURL(file);
  }
  document.execCommand("insertImage",false,url);
};

function fileToDataURL(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

// ------- PDF Tools -------
const { jsPDF } = window.jspdf;

$("#imgToPdfInput").onchange=(e)=>{
  $("#imgToPdfCount").textContent = (e.target.files?.length||0)+" ØµÙˆØ±";
};
$("#imgToPdfBtn").onclick=async()=>{
  const files=[...$("#imgToPdfInput").files||[]];
  if(!files.length) return alert("Ø§Ø®ØªØ§Ø± ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹");
  const pdf=new jsPDF();
  for(let i=0;i<files.length;i++){
    const data=await fileToDataURL(files[i]);
    const img=new Image();
    await new Promise(r=>{img.onload=r; img.src=data;});
    const w=pdf.internal.pageSize.getWidth();
    const h=(img.height/img.width)*w;
    if(i>0) pdf.addPage();
    pdf.addImage(img,"JPEG",0,0,w,h);
  }
  pdf.save("ATLAS-images.pdf");
};

let pdfjsLib=null;
(async()=>{
  // pdf.js is module; grab global from it
  try{
    const m = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.mjs");
    pdfjsLib=m;
    pdfjsLib.GlobalWorkerOptions.workerSrc=
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.mjs";
  }catch{}
})();

$("#pdfToImgInput").onchange=(e)=>{
  $("#pdfToImgName").textContent = e.target.files[0]?.name || "---";
};
$("#pdfToImgBtn").onclick=async()=>{
  const file=$("#pdfToImgInput").files[0];
  if(!file) return alert("Ø§Ø®ØªØ§Ø± PDF Ø£ÙˆÙ„Ø§Ù‹");
  if(!pdfjsLib) return alert("PDF engine not ready");
  const array=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:array}).promise;
  const maxPages=Math.min(pdf.numPages,5);
  for(let p=1;p<=maxPages;p++){
    const page=await pdf.getPage(p);
    const viewport=page.getViewport({scale:2});
    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=viewport.width; canvas.height=viewport.height;
    await page.render({canvasContext:ctx,viewport}).promise;
    const url=canvas.toDataURL("image/png");
    const a=document.createElement("a");
    a.href=url; a.download=`page-${p}.png`; a.click();
  }
  alert("ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙƒØµÙˆØ±.");
};

// ------- Timer -------
let timerTotal=25*60;
let timerLeft=timerTotal;
let timerInt=null;
function renderTimer(){
  const m=Math.floor(timerLeft/60).toString().padStart(2,"0");
  const s=(timerLeft%60).toString().padStart(2,"0");
  $("#timerDisplay").textContent=`${m}:${s}`;
}
renderTimer();

function setTimerMinutes(min){
  timerTotal=min*60; timerLeft=timerTotal; renderTimer();
  localStorage.setItem("atlas-timer-min",min);
}
(function(){
  const m=+localStorage.getItem("atlas-timer-min");
  if(m) setTimerMinutes(m);
})();

$("#startTimer").onclick=()=>{
  if(timerInt) return;
  timerInt=setInterval(()=>{
    timerLeft--;
    if(timerLeft<=0){
      clearInterval(timerInt); timerInt=null; timerLeft=0;
      alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª âœ…");
    }
    renderTimer();
  },1000);
};
$("#pauseTimer").onclick=()=>{
  clearInterval(timerInt); timerInt=null;
};
$("#resetTimer").onclick=()=>{
  timerLeft=timerTotal; renderTimer();
};
$$("[data-preset]").forEach(b=>{
  b.onclick=()=>setTimerMinutes(+b.dataset.preset);
});
$("#applyCustom").onclick=()=>{
  const m=+$("#customMinutes").value||25;
  setTimerMinutes(Math.max(1,m));
};

// ------- Online tag pulse -------
setInterval(()=>{
  $("#onlineTag").textContent = (navigator.onLine? "â— ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†" : "â— ØºÙŠØ± Ù…ØªØµÙ„");
},1500);

// ------- Boot -------
(async function boot(){
  await loadTracker();
  renderNotesList();
  setEditorEmpty();
})();
</script>

</body>
</html>
