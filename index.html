<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ATLAS Workspace â€” Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ</title>
  <meta name="theme-color" content="#05060a"/>
  <style>
    :root{
      --bg: #0a0d14;
      --bg2:#0f1420;
      --card:#131a28;
      --card2:#0e1524;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --accent:#4ea1ff;
      --accent2:#7b61ff;
      --ok:#35d07f;
      --warn:#ffcc55;
      --danger:#ff6b6b;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --glass: rgba(255,255,255,.04);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.08);
      --font: "system-ui",-apple-system,"Segoe UI",Tahoma,Arial;
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --bg2:#eef2f9; --card:#ffffff; --card2:#f7f9ff;
      --text:#0e1320; --muted:#55657e; --border:rgba(0,0,0,.08);
      --glass: rgba(0,0,0,.03); --glass2: rgba(0,0,0,.05);
      --shadow: 0 10px 25px rgba(20,30,50,.12);
    }
    [data-theme="oled"]{
      --bg:#000000; --bg2:#030307; --card:#05060a; --card2:#0a0b10;
      --text:#ecf2ff; --muted:#8ea0bd; --border:rgba(255,255,255,.07);
      --shadow: 0 10px 28px rgba(0,0,0,.9);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); background:
        radial-gradient(1200px 800px at 80% -10%, #1c2a66 0%, transparent 55%),
        radial-gradient(1200px 800px at -10% 30%, #1d3a2a 0%, transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* Layout */
    .app{
      max-width:1400px; margin:0 auto; padding:16px; display:grid; gap:14px;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "sidebar topbar profile"
        "sidebar main profile"
        "sidebar footer footer";
    }
    @media (max-width:1100px){
      .app{
        grid-template-columns: 1fr;
        grid-template-areas:
          "topbar"
          "main"
          "profile"
          "sidebar"
          "footer";
      }
    }

    /* Cards */
    .card{
      background:linear-gradient(180deg,var(--glass2),transparent),var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    /* Sidebar */
    .sidebar{grid-area:sidebar; position:sticky; top:12px; height:fit-content}
    .logo{
      display:flex; align-items:center; gap:10px; padding:10px 8px; margin-bottom:8px;
    }
    .logo .mark{
      width:44px;height:44px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #7b61ff, transparent 60%),
                  radial-gradient(circle at 70% 70%, #4ea1ff, transparent 60%),
                  #0d1220;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
    }
    .logo h1{font-size:18px;margin:0}
    .logo small{color:var(--muted)}
    .nav{
      display:grid; gap:8px; margin-top:6px;
    }
    .nav button{
      width:100%; text-align:right; padding:10px 12px; border-radius:12px;
      background:var(--card2); border:1px solid var(--border); color:var(--text);
      display:flex; align-items:center; justify-content:space-between; cursor:pointer;
      transition:.15s;
    }
    .nav button:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
    .nav button.active{
      background:linear-gradient(90deg,rgba(78,161,255,.16),transparent),var(--card2);
      border-color:rgba(78,161,255,.55);
      box-shadow:0 0 0 2px rgba(78,161,255,.15) inset;
    }

    /* Topbar */
    .topbar{grid-area:topbar; display:flex; gap:10px; align-items:center}
    .pill{
      background:var(--card); border:1px solid var(--border);
      padding:8px 10px; border-radius:12px; display:flex; gap:8px; align-items:center;
      box-shadow:var(--shadow);
    }
    .search{
      flex:1; display:flex; align-items:center; gap:8px;
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:8px 10px;
    }
    .search input{
      flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px;
    }

    .theme-row{display:flex; gap:6px; flex-wrap:wrap}
    .theme-btn{
      padding:7px 10px;border-radius:10px;border:1px solid var(--border);
      background:var(--card2); color:var(--text); cursor:pointer; font-size:12px;
    }
    .theme-btn.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(78,161,255,.15) inset;}

    /* Profile right */
    .profile{grid-area:profile; position:sticky; top:12px; height:fit-content}
    .profile-head{
      display:flex; align-items:center; gap:10px; margin-bottom:10px;
    }
    .avatar{
      width:44px;height:44px;border-radius:50%; background:var(--card2);
      border:1px solid var(--border); display:grid; place-items:center; font-weight:800;
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .profile-actions{display:flex; gap:6px; flex-wrap:wrap}
    .btn{
      padding:9px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--card2);color:var(--text);cursor:pointer;font-weight:600;
      transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,rgba(78,161,255,.2),rgba(123,97,255,.2)),var(--card2); border-color:rgba(78,161,255,.5)}
    .btn.danger{border-color:rgba(255,107,107,.6); background:rgba(255,107,107,.08)}

    /* Main */
    .main{grid-area:main; min-height:60vh}
    .section{display:none}
    .section.active{display:block}

    /* Home */
    .home-grid{
      display:grid; grid-template-columns:1.2fr 1fr; gap:12px;
    }
    @media (max-width:900px){.home-grid{grid-template-columns:1fr}}
    .welcome{
      padding:18px; display:grid; gap:6px; background:
        radial-gradient(800px 600px at 100% 0%, rgba(78,161,255,.25), transparent 55%),
        radial-gradient(800px 600px at 0% 100%, rgba(123,97,255,.25), transparent 55%),
        var(--card);
    }
    .welcome h2{margin:0;font-size:22px}
    .welcome p{margin:0;color:var(--muted);line-height:1.7}
    .quick-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:650px){.quick-cards{grid-template-columns:1fr 1fr}}
    .quick{
      padding:12px;border-radius:14px;background:var(--card2);
      border:1px solid var(--border); display:grid; gap:6px;
    }
    .quick .t{font-weight:700}
    .quick .s{color:var(--muted);font-size:12px}

    /* Tracker widgets */
    .tracker-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .tracker{
      background:var(--card2); border:1px solid var(--border); border-radius:14px;
      padding:10px; display:grid; gap:8px;
    }
    .tracker .row{display:flex;justify-content:space-between;align-items:center}
    .counter{
      display:flex;gap:6px;align-items:center;
    }
    .counter button{
      width:28px;height:28px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);color:var(--text);cursor:pointer;font-weight:900;
    }
    .counter input{
      width:64px;text-align:center;background:var(--card);border:1px solid var(--border);
      color:var(--text);border-radius:8px;padding:5px 6px;outline:none;
    }
    .small{font-size:12px;color:var(--muted)}

    /* Notes */
    .notes-wrap{display:grid; grid-template-columns:320px 1fr; gap:12px;}
    @media(max-width:900px){.notes-wrap{grid-template-columns:1fr}}
    .notes-list{
      display:grid; gap:8px; max-height:72vh; overflow:auto; padding-right:2px;
    }
    .note-item{
      padding:10px;border-radius:12px;background:var(--card2);border:1px solid var(--border);
      display:flex;gap:10px;align-items:center;cursor:pointer;
      transition:.12s;
    }
    .note-item:hover{transform:translateY(-1px); border-color:rgba(78,161,255,.4)}
    .note-item.active{border-color:var(--accent)}
    .note-thumb{
      width:44px;height:44px;border-radius:10px;background:var(--card);
      display:grid;place-items:center;font-size:22px;overflow:hidden;border:1px solid var(--border);
    }
    .note-thumb img{width:100%;height:100%;object-fit:cover}
    .note-meta{display:grid;gap:2px}
    .note-meta .title{font-weight:700}
    .note-meta .date{font-size:11px;color:var(--muted)}

    .editor{
      min-height:72vh; display:grid; gap:10px;
    }
    .editor-top{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .editor-top .left, .editor-top .right{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .title-input{
      width:100%; font-size:26px; font-weight:800; background:transparent; border:0; outline:0; color:var(--text);
    }
    .cover{
      height:160px;border-radius:16px;background:var(--card2);border:1px dashed var(--border);
      display:grid;place-items:center;overflow:hidden; position:relative;
    }
    .cover img{width:100%;height:100%;object-fit:cover}
    .cover .cover-actions{
      position:absolute; bottom:8px; left:8px; display:flex; gap:6px;
    }

    .toolbar{
      display:flex;gap:6px;flex-wrap:wrap;padding:8px;border-radius:12px;background:var(--card2);border:1px solid var(--border);
      position:sticky;top:6px;z-index:2;
    }
    .tool{
      padding:6px 8px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);cursor:pointer;font-size:12px;color:var(--text);
    }
    .tool select, .tool input[type="color"]{
      background:transparent;border:0;color:var(--text);outline:0;font-size:12px;cursor:pointer;
    }

    .content{
      background:var(--card2); border:1px solid var(--border); border-radius:12px;
      padding:12px; min-height:350px; line-height:1.8;
    }
    .content[contenteditable="true"]:focus{outline:2px solid rgba(78,161,255,.25)}
    .content img{max-width:100%;border-radius:12px;margin:8px 0}
    .content .block{
      padding:6px 4px; border-radius:8px;
    }

    /* PDF Tools */
    .pdf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.pdf-grid{grid-template-columns:1fr}}
    .pdf-card{display:grid;gap:8px}
    .drop{
      border:1px dashed var(--border); border-radius:12px; padding:14px; text-align:center; background:var(--card2);
    }
    .drop input{display:none}
    .drop label{cursor:pointer;display:block}

    /* Timer */
    .timer-wrap{
      display:grid; gap:10px; grid-template-columns:1fr 1fr;
    }
    @media(max-width:900px){.timer-wrap{grid-template-columns:1fr}}
    .timer-display{
      font-size:56px; font-weight:900; text-align:center; padding:22px; background:var(--card2);
      border:1px solid var(--border); border-radius:16px;
    }
    .timer-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    /* Footer */
    .footer{grid-area:footer; text-align:center; color:var(--muted); font-size:12px; padding:8px 0}

    /* Modal */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; z-index:10;
      padding:14px;
    }
    .modal.active{display:grid}
    .modal .box{
      width:min(520px,100%); background:var(--card); border:1px solid var(--border);
      border-radius:18px; padding:14px; display:grid; gap:10px;
      box-shadow:var(--shadow);
    }
    .field{
      display:grid; gap:6px;
    }
    .field input{
      background:var(--card2); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px; outline:none;
    }

    .hint{color:var(--muted); font-size:12px; line-height:1.6}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px; background:var(--glass2); border:1px solid var(--border)
    }
  
    /* PDF grid responsive improvement */
    @media (max-width:900px){ .pdf-grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:520px){ .pdf-grid{grid-template-columns:1fr;} }

    /* Language switch */
    .lang-switch{
      display:flex;align-items:center;gap:8px;
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:6px 8px;box-shadow:var(--shadow); font-size:12px;
    }
    .lang-switch .toggle{
      width:46px;height:24px;border-radius:999px;background:var(--card2);
      border:1px solid var(--border);position:relative;cursor:pointer;flex-shrink:0;
    }
    .lang-switch .knob{
      position:absolute;top:2px;right:2px;width:20px;height:20px;border-radius:50%;
      background:linear-gradient(180deg,#fff, #c9d6ff);transition:.2s;
      box-shadow:0 4px 10px rgba(0,0,0,.35);
    }
    [data-lang="en"] .lang-switch .knob{ right:auto; left:2px; }

  </style>
</head>
<body>
<div class="app" id="app">
  <!-- Sidebar -->
  <aside class="card sidebar">
    <div class="logo">
      <div class="mark">A</div>
      <div>
        <h1>ATLAS Workspace</h1>
        <small>ØµÙ†Ø¹Ù‡ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-sec="home" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© <span>ğŸ </span></button>
      <button data-sec="notes">Ø§Ù„Ù†ÙˆØªØ§Øª <span>ğŸ“</span></button>
      <button data-sec="pdf">Ø£Ø¯ÙˆØ§Øª PDF <span>ğŸ“„</span></button>
      <button data-sec="tracker">Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ… <span>âœ…</span></button>
      <button data-sec="timer">Ù…Ø¤Ù‚Øª <span>â±ï¸</span></button>
    </div>

    <div style="margin-top:10px" class="card">
      <div style="font-weight:800;margin-bottom:6px">Ø§Ù„Ø«ÙŠÙ…</div>
      <div class="theme-row">
        <button class="theme-btn active" data-theme="dark">Dark</button>
        <button class="theme-btn" data-theme="light">Light</button>
        <button class="theme-btn" data-theme="oled">OLED</button>
      </div>
      <div class="hint" style="margin-top:6px">Ø§Ù„Ø«ÙŠÙ… ÙŠÙ†Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
    </div>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="pill" id="greeting">...</div>
    <div class="search">
      ğŸ”
      <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØªØ© / ÙƒÙ„Ù…Ø©..." />
    </div>
    <div class="pill">
      <span class="tag" id="onlineTag">â— ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†</span>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Home -->
    <section class="section active" id="sec-home">
      <div class="home-grid">
        <div class="card welcome">
          <h2 id="welcomeTitle">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
          <p>
            Ù‡Ø°Ø§ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ + Ù†ÙˆØªØ§Øª Ø³ØªØ§ÙŠÙ„ Ù†ÙˆØ´Ù† + Ø£Ø¯ÙˆØ§Øª PDF
            ÙˆÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ø°Ø§ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„Ùƒ.
          </p>
          <div class="quick-cards" style="margin-top:10px">
            <div class="quick">
              <div class="t">Ù†ÙˆØªØ§Øª Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ©</div>
              <div class="s">ØµÙˆØ± + Ø¹Ù†Ø§ÙˆÙŠÙ† + ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ù…Ù„</div>
            </div>
            <div class="quick">
              <div class="t">Ø±ÙˆØªÙŠÙ† ÙŠÙˆÙ…ÙŠ</div>
              <div class="s">Ù…Ø§Ø¡ / Ù†ÙˆÙ… / ØµÙ„Ø§Ø© / Ø¬ÙŠÙ…</div>
            </div>
            <div class="quick">
              <div class="t">PDF Tools</div>
              <div class="s">ØµÙˆØ±â†”PDF / PDFâ†’ØµÙˆØ±</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:800;margin-bottom:8px">Ù„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† ÙŠÙˆÙ…Ùƒ</div>
          <div class="tracker-grid">
            <div class="tracker">
              <div class="row"><div>ğŸ’§ Ø§Ù„Ù…Ø§Ø¡</div><div class="small" id="w-water">0 ÙƒÙˆØ¨</div></div>
              <div class="counter">
                <button data-track="water" data-delta="-1">-</button>
                <input id="in-water" type="number" min="0" value="0"/>
                <button data-track="water" data-delta="1">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸŒ™ Ø§Ù„Ù†ÙˆÙ…</div><div class="small" id="w-sleep">0 Ø³Ø§Ø¹Ø©</div></div>
              <div class="counter">
                <button data-track="sleep" data-delta="-0.5">-</button>
                <input id="in-sleep" type="number" min="0" step="0.5" value="0"/>
                <button data-track="sleep" data-delta="0.5">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸ•Œ Ø§Ù„ØµÙ„Ø§Ø©</div><div class="small" id="w-prayer">0 / 5</div></div>
              <div class="counter">
                <button data-track="prayer" data-delta="-1">-</button>
                <input id="in-prayer" type="number" min="0" max="5" value="0"/>
                <button data-track="prayer" data-delta="1">+</button>
              </div>
            </div>

            <div class="tracker">
              <div class="row"><div>ğŸ‹ï¸ Ø§Ù„Ø¬ÙŠÙ…</div><div class="small" id="w-gym">0 Ø¯Ù‚ÙŠÙ‚Ø©</div></div>
              <div class="counter">
                <button data-track="gym" data-delta="-10">-</button>
                <input id="in-gym" type="number" min="0" step="10" value="0"/>
                <button data-track="gym" data-delta="10">+</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn primary" id="saveTracker">Ø­ÙØ¸ Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</button>
            <button class="btn" id="goTracker">Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØªÙŠÙ†</button>
          </div>
          <div class="hint">Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ø±ÙˆØªÙŠÙ† ÙŠÙ†Ø­ÙØ¸ Ø¹Ù†Ø¯Ùƒ ÙŠÙˆÙ…ÙŠØ§Ù‹.</div>
        </div>
      </div>
    </section>

    <!-- Notes -->
    <section class="section" id="sec-notes">
      <div class="notes-wrap">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:800">Ù†ÙˆØªØ§ØªÙƒ</div>
            <button class="btn primary" id="newNote">Ù†ÙˆØªØ© Ø¬Ø¯ÙŠØ¯Ø© +</button>
          </div>
          <div class="notes-list" id="notesList"></div>
          <div class="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ÙˆØªØ© Ù„ØªÙØªØ­Ù‡Ø§.</div>
        </div>

        <div class="card editor">
          <div class="editor-top">
            <div class="left">
              <button class="btn" id="pickEmoji">ğŸ˜€ Emoji</button>
              <button class="btn" id="setCoverBtn">ØºÙ„Ø§Ù / ØµÙˆØ±Ø©</button>
            </div>
            <div class="right">
              <button class="btn" id="saveNote">Ø­ÙØ¸</button>
              <button class="btn danger" id="deleteNote">Ø­Ø°Ù</button>
            </div>
          </div>

          <div class="cover" id="coverBox">
            <div>Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Cover</div>
            <input type="file" id="coverInput" accept="image/*" style="display:none">
            <div class="cover-actions">
              <button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button>
            </div>
          </div>

          <input class="title-input" id="noteTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†ÙˆØªØ©..." />

          <div class="toolbar">
            <button class="tool" data-cmd="bold"><b>B</b></button>
            <button class="tool" data-cmd="italic"><i>I</i></button>
            <button class="tool" data-cmd="underline"><u>U</u></button>
            <button class="tool" data-cmd="insertUnorderedList">â€¢ List</button>
            <button class="tool" data-cmd="formatBlock" data-arg="h2">H2</button>
            <button class="tool" data-cmd="formatBlock" data-arg="blockquote">Quote</button>

            <span class="tool">
              Ø§Ù„Ø®Ø·:
              <select id="fontFamily">
                <option value="system-ui">System</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Arial">Arial</option>
                <option value="'SF Pro Display',system-ui">SF Pro</option>
                <option value="'Cairo',Tahoma">Cairo</option>
              </select>
            </span>
            <span class="tool">
              Ø§Ù„Ø­Ø¬Ù…:
              <select id="fontSize">
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="22">22</option>
                <option value="26">26</option>
              </select>
            </span>
            <span class="tool">
              Ø§Ù„Ù„ÙˆÙ†:
              <input id="fontColor" type="color" value="#eaf0ff"/>
            </span>

            <button class="tool" id="addImageInline">Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ÙˆØªØ©</button>
            <input type="file" id="inlineImageInput" accept="image/*" style="display:none">
          </div>

          <div class="content" id="noteContent" contenteditable="true"></div>
          <div class="hint">
            * ØªÙ‚Ø¯Ø± ØªÙƒØªØ¨ Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨Ù†ÙØ³ Ø§Ù„Ù†ÙˆØªØ©.<br>
            * Ù„Ù…Ø§ ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ ÙƒÙ„ Ø´ÙŠØ¡ ÙŠÙ†Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ.
          </div>
        </div>
      </div>
    </section>

    <!-- PDF Tools -->
    <section class="section" id="sec-pdf">
      <div class="card">
        <div style="font-weight:900;font-size:18px;margin-bottom:10px">Ø£Ø¯ÙˆØ§Øª PDF Ø¯Ø§Ø®Ù„ ATLAS</div>
        
        <div class="pdf-grid">

          <!-- Images to PDF (local) -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ–¼ï¸ ØµÙˆØ± â†’ PDF</div>
            <div class="drop">
              <label for="imgToPdfInput">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</label>
              <input id="imgToPdfInput" type="file" accept="image/*" multiple>
              <div class="small" id="imgToPdfCount">0 ØµÙˆØ±</div>
            </div>
            <button class="btn primary" id="imgToPdfBtn">Ø­ÙˆÙ‘Ù„</button>
            <div class="hint">ÙŠØ¯Ø¹Ù… ØµÙˆØ± Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆÙŠØ¹Ø·ÙŠÙƒ Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯.</div>
          </div>

          <!-- PDF to Images (local) -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“„ PDF â†’ ØµÙˆØ±</div>
            <div class="drop">
              <label for="pdfToImgInput">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF</label>
              <input id="pdfToImgInput" type="file" accept="application/pdf">
              <div class="small" id="pdfToImgName">---</div>
            </div>
            <button class="btn primary" id="pdfToImgBtn">Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØ±</button>
            <div class="hint">ÙŠØ­ÙˆÙ„ ØµÙØ­Ø§Øª PDF Ø¥Ù„Ù‰ PNG (Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰).</div>
          </div>

          <!-- PowerPoint to PDF (external) -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“Š PowerPoint â†’ PDF</div>
            <div class="drop">
              <div class="small">Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„ PPTX Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯Ù‚Ø© 100%.</div>
            </div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/powerpoint_to_pdf">Ø§ÙØªØ­</a>
            <div class="hint">Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ù†Ø¶ÙŠÙ Ø³ÙŠØ±ÙØ± ØµØºÙŠØ± ÙˆÙŠØ­ÙˆÙ„Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.</div>
          </div>

          <!-- Word to PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“ Word â†’ PDF</div>
            <div class="hint">ØªØ­ÙˆÙŠÙ„ DOC/DOCX Ø¥Ù„Ù‰ PDF Ø¨Ø³Ù‡ÙˆÙ„Ø©.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/word_to_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- PDF to Word -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“„ PDF â†’ Word</div>
            <div class="hint">ØªØ­ÙˆÙŠÙ„ PDF Ø¥Ù„Ù‰ DOCX Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/pdf_to_word">Ø§ÙØªØ­</a>
          </div>

          <!-- Excel to PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“Š Excel â†’ PDF</div>
            <div class="hint">ØªØ­ÙˆÙŠÙ„ XLS/XLSX Ø¥Ù„Ù‰ PDF.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/excel_to_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- PDF to Excel -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ“„ PDF â†’ Excel</div>
            <div class="hint">Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ Excel.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/pdf_to_excel">Ø§ÙØªØ­</a>
          </div>

          <!-- Merge PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸŒ€ Ø¯Ù…Ø¬ Ù…Ù„ÙØ§Øª PDF</div>
            <div class="hint">Ø¯Ù…Ø¬ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/merge_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- Split PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">âœ‚ï¸ ØªÙ‚Ø³ÙŠÙ… PDF</div>
            <div class="hint">ØªØ¬Ø²Ø¦Ø© Ø§Ù„ØµÙØ­Ø§Øª Ø£Ùˆ ÙØµÙ„ Ù…Ù„Ù.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/split_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- Compress PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ—œï¸ Ø¶ØºØ· PDF</div>
            <div class="hint">ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/compress_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- Protect PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ” Ø­Ù…Ø§ÙŠØ© PDF</div>
            <div class="hint">Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ù„Ù.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/protect_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- Unlock PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ”“ ÙÙƒ Ø­Ù…Ø§ÙŠØ© PDF</div>
            <div class="hint">Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/unlock_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- Rotate PDF -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸ”„ ØªØ¯ÙˆÙŠØ± PDF</div>
            <div class="hint">ØªØ¯ÙˆÙŠØ± ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/rotate_pdf">Ø§ÙØªØ­</a>
          </div>

          <!-- PDF to HTML -->
          <div class="card pdf-card">
            <div style="font-weight:800">ğŸŒ PDF â†’ HTML</div>
            <div class="hint">ØªØ­ÙˆÙŠÙ„ PDF Ø¥Ù„Ù‰ ØµÙØ­Ø© HTML.</div>
            <a class="btn primary" target="_blank" href="https://www.ilovepdf.com/pdf_to_html">Ø§ÙØªØ­</a>
          </div>

        </div>
>
    </section>

    <!-- Tracker page -->
    <section class="section" id="sec-tracker">
      <div class="card">
        <div style="font-weight:900;font-size:18px;margin-bottom:8px">Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ… âœ…</div>
        <div class="tracker-grid">

          <div class="tracker">
            <div class="row"><div>ğŸ’§ Ø§Ù„Ù…Ø§Ø¡</div><div class="small" id="t-water">0 ÙƒÙˆØ¨</div></div>
            <div class="counter">
              <button data-track="water" data-delta="-1">-</button>
              <input id="t-in-water" type="number" min="0" value="0"/>
              <button data-track="water" data-delta="1">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸŒ™ Ø§Ù„Ù†ÙˆÙ…</div><div class="small" id="t-sleep">0 Ø³Ø§Ø¹Ø©</div></div>
            <div class="counter">
              <button data-track="sleep" data-delta="-0.5">-</button>
              <input id="t-in-sleep" type="number" min="0" step="0.5" value="0"/>
              <button data-track="sleep" data-delta="0.5">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸ•Œ Ø§Ù„ØµÙ„Ø§Ø©</div><div class="small" id="t-prayer">0 / 5</div></div>
            <div class="counter">
              <button data-track="prayer" data-delta="-1">-</button>
              <input id="t-in-prayer" type="number" min="0" max="5" value="0"/>
              <button data-track="prayer" data-delta="1">+</button>
            </div>
          </div>

          <div class="tracker">
            <div class="row"><div>ğŸ‹ï¸ Ø§Ù„Ø¬ÙŠÙ…</div><div class="small" id="t-gym">0 Ø¯Ù‚ÙŠÙ‚Ø©</div></div>
            <div class="counter">
              <button data-track="gym" data-delta="-10">-</button>
              <input id="t-in-gym" type="number" min="0" step="10" value="0"/>
              <button data-track="gym" data-delta="10">+</button>
            </div>
          
          <!-- Word to PDF -->
<div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="saveTracker2">Ø­ÙØ¸</button>
          <button class="btn" id="loadTracker2">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
      </div>
    </section>

    <!-- Timer -->
    <section class="section" id="sec-timer">
      <div class="timer-wrap">
        <div class="card">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px">â±ï¸ Ù…Ø¤Ù‚Øª / Pomodoro</div>
          <div class="timer-display" id="timerDisplay">25:00</div>
          <div class="timer-controls">
            <button class="btn primary" id="startTimer">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn" id="pauseTimer">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
            <button class="btn" id="resetTimer">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>
        <div class="card">
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn" data-preset="25">Pomodoro 25</button>
            <button class="btn" data-preset="50">Focus 50</button>
            <button class="btn" data-preset="10">Break 10</button>
          </div>
          <div class="field" style="margin-top:10px">
            <label>Ù…Ø¯Ø© Ù…Ø®ØµØµØ© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="customMinutes" type="number" min="1" value="25"/>
          </div>
          <button class="btn primary" id="applyCustom" style="margin-top:8px">ØªØ·Ø¨ÙŠÙ‚</button>
          <div class="hint">Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø³ÙŠØ· ÙˆØ¹Ù…Ù„ÙŠ Ù„Ø±ÙˆØªÙŠÙ†Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Profile -->
  <aside class="card profile">
    <div class="profile-head">
      <div class="avatar" id="avatarBox">A</div>
      <div>
        <div style="font-weight:800" id="userName">Ø¶ÙŠÙ</div>
        <div class="small" id="userEmail">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
      </div>
    </div>

    <div class="profile-actions">
      <button class="btn primary" id="googleLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google</button>
      <button class="btn" id="guestMode">Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ¶ÙŠÙ</button>
      <button class="btn danger" id="logoutBtn" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      <button class="btn" id="editProfileBtn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>

    <div style="margin-top:10px" class="card">
      <div style="font-weight:800;margin-bottom:6px">Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</div>
      <div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØªØ§Øª: <span id="statNotes">0</span></div>
      <div class="small">Ø¢Ø®Ø± Ø­ÙØ¸: <span id="statLast">â€”</span></div>
    </div>

    <div style="margin-top:10px" class="hint">
      ATLAS Workspace â€” Ù…Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„Ù…ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ§Ù„Ù†ÙˆØªØ§Øª ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„Ø­ÙŠØ§Ø©.
    </div>
  </aside>

  <footer class="footer">
    Â© ATLAS Workspace â€” ØµÙ†Ø¹Ù‡ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„ØµÙ…Ø§Ø¯ÙŠ
  </footer>
</div>

<!-- Modal Profile -->
<div class="modal" id="profileModal">
  <div class="box">
    <div style="font-weight:900;font-size:18px">ØªØ®ØµÙŠØµ Ø§Ø³Ù…Ùƒ</div>
    <div class="field">
      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="profileNameInput" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯"/>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeProfileModal">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn primary" id="saveProfileModal">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Emoji prompt -->
<div class="modal" id="emojiModal">
  <div class="box">
    <div style="font-weight:900;font-size:18px">Ø§Ø®ØªØ± Emoji Ù„Ù„Ù†ÙˆØªØ©</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;font-size:22px">
      <button class="tool em">ğŸ˜€</button><button class="tool em">âœ¨</button><button class="tool em">ğŸ“Œ</button>
      <button class="tool em">ğŸ”¥</button><button class="tool em">ğŸŒ™</button><button class="tool em">ğŸ’¡</button>
      <button class="tool em">âœ…</button><button class="tool em">ğŸ“š</button><button class="tool em">ğŸ®</button>
      <button class="tool em">ğŸ‹ï¸</button><button class="tool em">ğŸ§ </button><button class="tool em">â¤ï¸</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeEmoji">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Firebase compat CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.mjs" type="module"></script>

<script>
/* ==============================
   ATLAS Workspace â€” Single file
   by Mahmoud Smadi
================================ */

// ------- Firebase Config (your keys) ------
const firebaseConfig = {
  apiKey: "AIzaSyDTOtQbGaLpGtDc34GXzcdppCvEJ60TYSs",
  authDomain: "atlas-workspace.firebaseapp.com",
  projectId: "atlas-workspace",
  storageBucket: "atlas-workspace.firebasestorage.app",
  messagingSenderId: "95882710960",
  appId: "1:95882710960:web:9fcafcc1d4d057029ad075",
  measurementId: "G-KJ446WXXHG"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const storage = firebase.storage();

// ------- State ------
let currentUser = null;
let notes = [];
let currentNoteId = null;
let currentEmoji = "ğŸ“";
let currentCoverURL = "";
let isGuest = true;

// ------- Helpers ------
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);

const todayKey = ()=>{
  const d=new Date();
  return d.toISOString().slice(0,10);
};
const niceDate = (ts)=>{
  try{
    const d = ts?.toDate ? ts.toDate() : (ts? new Date(ts): new Date());
    return d.toLocaleString("ar",{hour12:true});
  }catch{return "â€”"}
};

function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("atlas-theme", theme);
  $$(".theme-btn").forEach(b=>b.classList.toggle("active", b.dataset.theme===theme));
  if(currentUser && !isGuest){
    db.collection("users").doc(currentUser.uid).set({theme},{merge:true});
  }
}
(function initTheme(){
  const t = localStorage.getItem("atlas-theme") || "dark";
  setTheme(t);
})();

// ------- Nav / Sections ------
$("#nav").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-sec]");
  if(!btn) return;
  const sec = btn.dataset.sec;

  $$("#nav button").forEach(b=>b.classList.toggle("active", b===btn));
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-"+sec).classList.add("active");
});


// ------- i18n (Arabic / English) -------
let currentLang = localStorage.getItem("atlas-lang") || "ar";

const i18n = {
  ar: {
    nav_home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", nav_notes:"Ø§Ù„Ù†ÙˆØªØ§Øª", nav_pdf:"Ø£Ø¯ÙˆØ§Øª PDF", nav_tracker:"Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…", nav_timer:"Ù…Ø¤Ù‚Øª",
    search_ph:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØªØ© / ÙƒÙ„Ù…Ø©...",
    home_welcome:"Ù‡Ø°Ø§ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ + Ù†ÙˆØªØ§Øª Ø³ØªØ§ÙŠÙ„ Ù†ÙˆØ´Ù† + Ø£Ø¯ÙˆØ§Øª PDF ÙˆÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ø°Ø§ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„Ùƒ.",
    quick1_t:"Ù†ÙˆØªØ§Øª Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ©", quick1_s:"ØµÙˆØ± + Ø¹Ù†Ø§ÙˆÙŠÙ† + ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ù…Ù„",
    quick2_t:"Ø±ÙˆØªÙŠÙ† ÙŠÙˆÙ…ÙŠ", quick2_s:"Ù…Ø§Ø¡ / Ù†ÙˆÙ… / ØµÙ„Ø§Ø© / Ø¬ÙŠÙ…",
    quick3_t:"PDF Tools", quick3_s:"ØµÙˆØ±â†”PDF / PDFâ†’ØµÙˆØ±",
    home_snapshot:"Ù„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† ÙŠÙˆÙ…Ùƒ",
    save_routine:"Ø­ÙØ¸ Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…", open_routine:"Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØªÙŠÙ†",
    notes_title:"Ù†ÙˆØªØ§ØªÙƒ", new_note:"Ù†ÙˆØªØ© Ø¬Ø¯ÙŠØ¯Ø© +", save:"Ø­ÙØ¸", delete:"Ø­Ø°Ù",
    cover_btn:"ØºÙ„Ø§Ù / ØµÙˆØ±Ø©", emoji_btn:"ğŸ˜€ Emoji",
    pdf_title:"Ø£Ø¯ÙˆØ§Øª PDF Ø¯Ø§Ø®Ù„ ATLAS",
    timer_title:"â±ï¸ Ù…Ø¤Ù‚Øª / Pomodoro", start:"Ø§Ø¨Ø¯Ø£", pause:"Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª", reset:"Ø¥Ø¹Ø§Ø¯Ø©",
    custom_label:"Ù…Ø¯Ø© Ù…Ø®ØµØµØ© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)", apply:"ØªØ·Ø¨ÙŠÙ‚",
    login_google:"ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google", guest:"Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ¶ÙŠÙ", logout:"ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", edit_name:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…",
    stats:"Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ", stat_notes_lbl:"Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØªØ§Øª:", stat_last_lbl:"Ø¢Ø®Ø± Ø­ÙØ¸:",
    modal_profile_title:"ØªØ®ØµÙŠØµ Ø§Ø³Ù…Ùƒ", modal_name_lbl:"Ø§Ù„Ø§Ø³Ù…", cancel:"Ø¥Ù„ØºØ§Ø¡",
    online_on:"â— ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†", online_off:"â— ØºÙŠØ± Ù…ØªØµÙ„"
  },
  en: {
    nav_home:"Home", nav_notes:"Notes", nav_pdf:"PDF Tools", nav_tracker:"Daily Routine", nav_timer:"Timer",
    search_ph:"Search notes / keyword...",
    home_welcome:"Your allâ€‘inâ€‘one personal workspace for daily routine, Notionâ€‘style notes, and PDF tools. Everything is saved to your account when you sign in.",
    quick1_t:"Creative Notes", quick1_s:"Images + covers + full formatting",
    quick2_t:"Daily Routine", quick2_s:"Water / Sleep / Prayer / Gym",
    quick3_t:"PDF Tools", quick3_s:"Imagesâ†”PDF / PDFâ†’Images",
    home_snapshot:"Quick look at your day",
    save_routine:"Save todayâ€™s routine", open_routine:"Open routine page",
    notes_title:"Your Notes", new_note:"New note +", save:"Save", delete:"Delete",
    cover_btn:"Cover / Image", emoji_btn:"ğŸ˜€ Emoji",
    pdf_title:"PDF tools inside ATLAS",
    timer_title:"â±ï¸ Timer / Pomodoro", start:"Start", pause:"Pause", reset:"Reset",
    custom_label:"Custom duration (minutes)", apply:"Apply",
    login_google:"Sign in with Google", guest:"Continue as guest", logout:"Sign out", edit_name:"Edit name",
    stats:"Your stats", stat_notes_lbl:"Notes count:", stat_last_lbl:"Last saved:",
    modal_profile_title:"Customize your name", modal_name_lbl:"Name", cancel:"Cancel",
    online_on:"â— Online", online_off:"â— Offline"
  }
};

function applyLang(lang){
  currentLang = lang;
  localStorage.setItem("atlas-lang", lang);
  document.documentElement.setAttribute("data-lang", lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang==="ar") ? "rtl" : "ltr";

  const T=i18n[lang];

  // nav buttons (keep icons)
  const navMap = {home:"nav_home", notes:"nav_notes", pdf:"nav_pdf", tracker:"nav_tracker", timer:"nav_timer"};
  document.querySelectorAll('#nav button[data-sec]').forEach(btn=>{
    const sec=btn.dataset.sec;
    const key=navMap[sec];
    const icon=btn.querySelector("span")?.outerHTML || "";
    btn.innerHTML = `${T[key]} ${icon}`;
  });

  // placeholders & headings
  const searchInput=document.getElementById("searchInput");
  if(searchInput) searchInput.placeholder=T.search_ph;

  const welcomeP=document.querySelector("#sec-home .welcome p");
  if(welcomeP) welcomeP.textContent=T.home_welcome;

  const quicks=document.querySelectorAll("#sec-home .quick");
  if(quicks[0]){quicks[0].querySelector(".t").textContent=T.quick1_t; quicks[0].querySelector(".s").textContent=T.quick1_s;}
  if(quicks[1]){quicks[1].querySelector(".t").textContent=T.quick2_t; quicks[1].querySelector(".s").textContent=T.quick2_s;}
  if(quicks[2]){quicks[2].querySelector(".t").textContent=T.quick3_t; quicks[2].querySelector(".s").textContent=T.quick3_s;}

  const snapshot=document.querySelector("#sec-home .card:nth-child(2) > div");
  if(snapshot) snapshot.textContent=T.home_snapshot;

  const saveTracker=document.getElementById("saveTracker");
  if(saveTracker) saveTracker.textContent=T.save_routine;
  const goTracker=document.getElementById("goTracker");
  if(goTracker) goTracker.textContent=T.open_routine;

  const notesTitle=document.querySelector("#sec-notes .notes-wrap .card > div > div");
  if(notesTitle) notesTitle.textContent=T.notes_title;
  const newNote=document.getElementById("newNote");
  if(newNote) newNote.textContent=T.new_note;
  const saveNote=document.getElementById("saveNote");
  if(saveNote) saveNote.textContent=T.save;
  const deleteNote=document.getElementById("deleteNote");
  if(deleteNote) deleteNote.textContent=T.delete;
  const setCoverBtn=document.getElementById("setCoverBtn");
  if(setCoverBtn) setCoverBtn.textContent=T.cover_btn;
  const pickEmoji=document.getElementById("pickEmoji");
  if(pickEmoji) pickEmoji.textContent=T.emoji_btn;

  const pdfTitle=document.querySelector("#sec-pdf .card > div");
  if(pdfTitle) pdfTitle.textContent=T.pdf_title;

  const timerTitle=document.querySelector("#sec-timer .card > div");
  if(timerTitle) timerTitle.textContent=T.timer_title;
  const startTimer=document.getElementById("startTimer");
  if(startTimer) startTimer.textContent=T.start;
  const pauseTimer=document.getElementById("pauseTimer");
  if(pauseTimer) pauseTimer.textContent=T.pause;
  const resetTimer=document.getElementById("resetTimer");
  if(resetTimer) resetTimer.textContent=T.reset;
  const customLabel=document.querySelector("#sec-timer .field label");
  if(customLabel) customLabel.textContent=T.custom_label;
  const applyCustom=document.getElementById("applyCustom");
  if(applyCustom) applyCustom.textContent=T.apply;

  const googleLogin=document.getElementById("googleLogin");
  if(googleLogin) googleLogin.textContent=T.login_google;
  const guestMode=document.getElementById("guestMode");
  if(guestMode) guestMode.textContent=T.guest;
  const logoutBtn=document.getElementById("logoutBtn");
  if(logoutBtn) logoutBtn.textContent=T.logout;
  const editProfileBtn=document.getElementById("editProfileBtn");
  if(editProfileBtn) editProfileBtn.textContent=T.edit_name;

  const statsTitle=document.querySelector(".profile .card:nth-of-type(1) > div");
  if(statsTitle) statsTitle.textContent=T.stats;
  const statNotesLbl=document.querySelector(".profile .card:nth-of-type(1) .small:nth-of-type(1)");
  if(statNotesLbl) statNotesLbl.firstChild.textContent = T.stat_notes_lbl+" ";
  const statLastLbl=document.querySelector(".profile .card:nth-of-type(1) .small:nth-of-type(2)");
  if(statLastLbl) statLastLbl.firstChild.textContent = T.stat_last_lbl+" ";

  const modalProfileTitle=document.querySelector("#profileModal .box > div");
  if(modalProfileTitle) modalProfileTitle.textContent=T.modal_profile_title;
  const modalNameLbl=document.querySelector("#profileModal label");
  if(modalNameLbl) modalNameLbl.textContent=T.modal_name_lbl;
  const closeProfileModal=document.getElementById("closeProfileModal");
  if(closeProfileModal) closeProfileModal.textContent=T.cancel;

  // lang switch label
  const langLabel=document.getElementById("langLabel");
  if(langLabel) langLabel.textContent = (lang==="ar") ? "AR" : "EN";

  // re-render greeting in right language (simple)
  updateGreeting((document.getElementById("userName")?.textContent || "").replace("Ø¶ÙŠÙ","").trim());
}

document.getElementById("langToggle")?.addEventListener("click", ()=>{
  applyLang(currentLang==="ar"?"en":"ar");
});

// ------- Greeting ------
function updateGreeting(name=""){
  const h = new Date().getHours();
  const g = h<12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±" : (h<18 ? "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±");
  $("#greeting").textContent = `${g} ${name? "ÙŠØ§ "+name : ""} ğŸŒ™`;
  $("#welcomeTitle").textContent = `${g} ${name? name : ""} ğŸ‘‹`;
}

// ------- Auth UI ------
async function signInGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
}
async function signOut(){
  await auth.signOut();
}

$("#googleLogin").onclick = signInGoogle;
$("#logoutBtn").onclick = signOut;
$("#guestMode").onclick = ()=>{
  isGuest = true;
  currentUser = null;
  setUserUI();
  loadLocalNotes();
  loadLocalTracker();
};

auth.onAuthStateChanged(async(user)=>{
  if(user){
    currentUser = user;
    isGuest = false;
    await loadUserProfile();
    await loadNotes();
    await loadTracker();
  }else{
    currentUser = null;
    isGuest = true;
    loadLocalNotes();
    loadLocalTracker();
  }
  setUserUI();
});

async function loadUserProfile(){
  const ref = db.collection("users").doc(currentUser.uid);
  const snap = await ref.get();
  const data = snap.exists ? snap.data() : {};
  const name = data.name || currentUser.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
  updateGreeting(name);
  $("#userName").textContent = name;
  $("#profileNameInput").value = name;
  if(data.theme) setTheme(data.theme);
}

function setUserUI(){
  if(currentUser && !isGuest){
    $("#userName").textContent = currentUser.displayName || $("#userName").textContent;
    $("#userEmail").textContent = currentUser.email || "";
    $("#logoutBtn").style.display="inline-block";
    $("#googleLogin").style.display="none";
    $("#guestMode").style.display="none";
    const photo = currentUser.photoURL;
    if(photo){
      $("#avatarBox").innerHTML = `<img src="${photo}">`;
    }else{
      $("#avatarBox").textContent = (currentUser.displayName||"A").slice(0,1).toUpperCase();
    }
  }else{
    $("#userName").textContent = "Ø¶ÙŠÙ";
    $("#userEmail").textContent = "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ";
    $("#logoutBtn").style.display="none";
    $("#googleLogin").style.display="inline-block";
    $("#guestMode").style.display="inline-block";
    $("#avatarBox").textContent="A";
    updateGreeting("");
  }
}

// ------- Profile modal ------
$("#editProfileBtn").onclick=()=>$("#profileModal").classList.add("active");
$("#closeProfileModal").onclick=()=>$("#profileModal").classList.remove("active");
$("#saveProfileModal").onclick=async()=>{
  const name = $("#profileNameInput").value.trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
  $("#profileModal").classList.remove("active");
  updateGreeting(name);
  $("#userName").textContent = name;
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid).set({name},{merge:true});
  }else{
    localStorage.setItem("atlas-guest-name", name);
  }
};

// restore guest name
(function(){
  const n = localStorage.getItem("atlas-guest-name");
  if(n) updateGreeting(n);
})();

// ------- Theme buttons ------
$$(".theme-btn").forEach(b=>{
  b.onclick=()=>setTheme(b.dataset.theme);
});

// ------- Tracker -------
let trackerState = {water:0,sleep:0,prayer:0,gym:0};

function syncTrackerInputs(){
  const map = [
    ["water","in-water","w-water","t-in-water","t-water"," ÙƒÙˆØ¨"],
    ["sleep","in-sleep","w-sleep","t-in-sleep","t-sleep"," Ø³Ø§Ø¹Ø©"],
    ["prayer","in-prayer","w-prayer","t-in-prayer","t-prayer"," / 5"],
    ["gym","in-gym","w-gym","t-in-gym","t-gym"," Ø¯Ù‚ÙŠÙ‚Ø©"]
  ];
  map.forEach(([k,a,b,c,d,suf])=>{
    if($("#"+a)) $("#"+a).value = trackerState[k];
    if($("#"+c)) $("#"+c).value = trackerState[k];
    if($("#"+b)) $("#"+b).textContent = trackerState[k]+suf;
    if($("#"+d)) $("#"+d).textContent = trackerState[k]+suf;
  });
}

document.body.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-track]");
  if(!btn) return;
  const k = btn.dataset.track;
  const delta = parseFloat(btn.dataset.delta);
  trackerState[k] = Math.max(0, (trackerState[k]||0) + delta);
  if(k==="prayer") trackerState[k]=Math.min(5, trackerState[k]);
  syncTrackerInputs();
});

$("#saveTracker").onclick=saveTracker;
$("#saveTracker2").onclick=saveTracker;
$("#loadTracker2").onclick=loadTracker;
$("#goTracker").onclick=()=>{
  $$("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.sec==="tracker"));
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-tracker").classList.add("active");
};

async function saveTracker(){
  const key = todayKey();
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid)
      .collection("trackers").doc(key)
      .set({...trackerState, updatedAt: Date.now()},{merge:true});
  }else{
    localStorage.setItem("atlas-tracker-"+key, JSON.stringify(trackerState));
  }
}

async function loadTracker(){
  const key = todayKey();
  if(currentUser && !isGuest){
    const doc = await db.collection("users").doc(currentUser.uid)
      .collection("trackers").doc(key).get();
    trackerState = doc.exists ? doc.data() : trackerState;
  }else{
    const j = localStorage.getItem("atlas-tracker-"+key);
    if(j) trackerState = JSON.parse(j);
  }
  syncTrackerInputs();
}
function loadLocalTracker(){ loadTracker(); }

// ------- Notes -------
function renderNotesList(filter=""){
  const list = $("#notesList");
  list.innerHTML="";
  const filtered = notes.filter(n=>{
    if(!filter) return true;
    const t = (n.title||"").toLowerCase();
    const c = (n.contentHTML||"").toLowerCase();
    return t.includes(filter)||c.includes(filter);
  });

  filtered.forEach(n=>{
    const div = document.createElement("div");
    div.className="note-item"+(n.id===currentNoteId?" active":"");
    div.dataset.id=n.id;
    div.innerHTML=`
      <div class="note-thumb">${n.coverURL?`<img src="${n.coverURL}">`:n.emoji||"ğŸ“"}</div>
      <div class="note-meta">
        <div class="title">${n.title||"Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</div>
        <div class="date">${niceDate(n.updatedAt||n.createdAt)}</div>
      </div>
    `;
    div.onclick=()=>openNote(n.id);
    list.appendChild(div);
  });
  $("#statNotes").textContent = notes.length;
}

function setEditorEmpty(){
  currentNoteId=null;
  currentEmoji="ğŸ“";
  currentCoverURL="";
  $("#noteTitle").value="";
  $("#noteContent").innerHTML="";
  $("#coverBox").innerHTML=`<div>Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Cover</div><input type="file" id="coverInput" accept="image/*" style="display:none">
    <div class="cover-actions"><button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button></div>`;
  bindCoverHandlers();
}

$("#newNote").onclick=()=>{
  setEditorEmpty();
  $("#noteTitle").focus();
};

function openNote(id){
  const n = notes.find(x=>x.id===id);
  if(!n) return;
  currentNoteId=id;
  currentEmoji=n.emoji||"ğŸ“";
  currentCoverURL=n.coverURL||"";
  $("#noteTitle").value=n.title||"";
  $("#noteContent").innerHTML=n.contentHTML||"";
  applyStyleToEditor(n.style||{});
  renderCover(currentCoverURL);
  renderNotesList($("#searchInput").value.trim().toLowerCase());
}

function applyStyleToEditor(style){
  const fam=style.fontFamily || "system-ui";
  const size=style.fontSize || 18;
  const color=style.color || getComputedStyle(document.documentElement).getPropertyValue("--text");
  $("#fontFamily").value=fam;
  $("#fontSize").value=size;
  $("#fontColor").value=rgbToHex(color);
  $("#noteContent").style.fontFamily=fam;
  $("#noteContent").style.fontSize=size+"px";
  $("#noteContent").style.color=color;
}

function rgbToHex(rgb){
  if(!rgb) return "#eaf0ff";
  if(rgb.startsWith("#")) return rgb;
  const m = rgb.match(/\d+/g);
  if(!m) return "#eaf0ff";
  return "#"+m.slice(0,3).map(x=>("0"+parseInt(x).toString(16)).slice(-2)).join("");
}

async function loadNotes(){
  if(!(currentUser && !isGuest)){ return; }
  const snap = await db.collection("users").doc(currentUser.uid).collection("notes")
    .orderBy("updatedAt","desc").get();
  notes = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderNotesList();
  if(notes[0]) openNote(notes[0].id);
}

function loadLocalNotes(){
  const j = localStorage.getItem("atlas-guest-notes");
  notes = j? JSON.parse(j): [];
  renderNotesList();
  if(notes[0]) openNote(notes[0].id);
}

async function saveNotesLocal(){
  localStorage.setItem("atlas-guest-notes", JSON.stringify(notes));
}

$("#saveNote").onclick=async()=>{
  const title = $("#noteTitle").value.trim();
  const contentHTML = $("#noteContent").innerHTML.trim();
  const style={
    fontFamily: $("#fontFamily").value,
    fontSize: parseInt($("#fontSize").value),
    color: $("#fontColor").value
  };
  const payload = {
    title, contentHTML,
    emoji: currentEmoji,
    coverURL: currentCoverURL,
    style,
    updatedAt: Date.now(),
    createdAt: currentNoteId? undefined : Date.now()
  };

  if(currentUser && !isGuest){
    const ref = currentNoteId
      ? db.collection("users").doc(currentUser.uid).collection("notes").doc(currentNoteId)
      : db.collection("users").doc(currentUser.uid).collection("notes").doc();

    if(!currentNoteId) currentNoteId = ref.id;
    await ref.set(payload,{merge:true});
    $("#statLast").textContent = niceDate(Date.now());
    await loadNotes();
  }else{
    if(currentNoteId){
      const idx = notes.findIndex(n=>n.id===currentNoteId);
      notes[idx]={...notes[idx],...payload};
    }else{
      currentNoteId="g_"+Date.now();
      notes.unshift({id:currentNoteId,...payload});
    }
    await saveNotesLocal();
    renderNotesList();
  }
};

$("#deleteNote").onclick=async()=>{
  if(!currentNoteId) return;
  if(!confirm("Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„Ù†ÙˆØªØ©ØŸ")) return;
  if(currentUser && !isGuest){
    await db.collection("users").doc(currentUser.uid).collection("notes").doc(currentNoteId).delete();
    currentNoteId=null;
    await loadNotes();
  }else{
    notes = notes.filter(n=>n.id!==currentNoteId);
    currentNoteId=null;
    await saveNotesLocal();
    renderNotesList();
    setEditorEmpty();
  }
};

$("#searchInput").addEventListener("input",(e)=>{
  renderNotesList(e.target.value.trim().toLowerCase());
});

// ------- Toolbar formatting -------
$$(".tool[data-cmd]").forEach(b=>{
  b.onclick=()=>{
    const cmd=b.dataset.cmd;
    const arg=b.dataset.arg||null;
    document.execCommand(cmd,false,arg);
    $("#noteContent").focus();
  };
});
$("#fontFamily").onchange=()=>{
  $("#noteContent").style.fontFamily=$("#fontFamily").value;
};
$("#fontSize").onchange=()=>{
  $("#noteContent").style.fontSize=$("#fontSize").value+"px";
};
$("#fontColor").onchange=()=>{
  $("#noteContent").style.color=$("#fontColor").value;
};

// ------- Emoji -------
$("#pickEmoji").onclick=()=>$("#emojiModal").classList.add("active");
$("#closeEmoji").onclick=()=>$("#emojiModal").classList.remove("active");
$$(".em").forEach(btn=>{
  btn.onclick=()=>{
    currentEmoji = btn.textContent.trim();
    $("#emojiModal").classList.remove("active");
    renderNotesList($("#searchInput").value.trim().toLowerCase());
  };
});

// ------- Cover handlers -------
function bindCoverHandlers(){
  const coverBox=$("#coverBox");
  const coverInput=$("#coverInput");
  if(!coverBox||!coverInput) return;

  coverBox.onclick=()=>coverInput.click();
  coverInput.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    if(currentUser && !isGuest){
      const path=`covers/${currentUser.uid}/${Date.now()}_${file.name}`;
      const task=await storage.ref(path).put(file);
      currentCoverURL=await task.ref.getDownloadURL();
    }else{
      currentCoverURL=await fileToDataURL(file);
    }
    renderCover(currentCoverURL);
  };
  $("#removeCover").onclick=(ev)=>{
    ev.stopPropagation();
    currentCoverURL="";
    renderCover("");
  };
}
bindCoverHandlers();

function renderCover(url){
  const box=$("#coverBox");
  if(!box) return;
  if(url){
    box.innerHTML=`<img src="${url}"><input type="file" id="coverInput" accept="image/*" style="display:none">
      <div class="cover-actions"><button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button></div>`;
  }else{
    box.innerHTML=`<div>Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Cover</div><input type="file" id="coverInput" accept="image/*" style="display:none">
      <div class="cover-actions"><button class="btn" id="removeCover">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºÙ„Ø§Ù</button></div>`;
  }
  bindCoverHandlers();
}
$("#setCoverBtn").onclick=()=>$("#coverInput")?.click();

// inline image
$("#addImageInline").onclick=()=>$("#inlineImageInput").click();
$("#inlineImageInput").onchange=async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  let url="";
  if(currentUser && !isGuest){
    const path=`note-images/${currentUser.uid}/${Date.now()}_${file.name}`;
    const task=await storage.ref(path).put(file);
    url=await task.ref.getDownloadURL();
  }else{
    url=await fileToDataURL(file);
  }
  document.execCommand("insertImage",false,url);
};

function fileToDataURL(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

// ------- PDF Tools -------
const { jsPDF } = window.jspdf;

$("#imgToPdfInput").onchange=(e)=>{
  $("#imgToPdfCount").textContent = (e.target.files?.length||0)+" ØµÙˆØ±";
};
$("#imgToPdfBtn").onclick=async()=>{
  const files=[...$("#imgToPdfInput").files||[]];
  if(!files.length) return alert("Ø§Ø®ØªØ§Ø± ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹");
  const pdf=new jsPDF();
  for(let i=0;i<files.length;i++){
    const data=await fileToDataURL(files[i]);
    const img=new Image();
    await new Promise(r=>{img.onload=r; img.src=data;});
    const w=pdf.internal.pageSize.getWidth();
    const h=(img.height/img.width)*w;
    if(i>0) pdf.addPage();
    pdf.addImage(img,"JPEG",0,0,w,h);
  }
  pdf.save("ATLAS-images.pdf");
};

let pdfjsLib=null;
(async()=>{
  // pdf.js is module; grab global from it
  try{
    const m = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.mjs");
    pdfjsLib=m;
    pdfjsLib.GlobalWorkerOptions.workerSrc=
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.mjs";
  }catch{}
})();

$("#pdfToImgInput").onchange=(e)=>{
  $("#pdfToImgName").textContent = e.target.files[0]?.name || "---";
};
$("#pdfToImgBtn").onclick=async()=>{
  const file=$("#pdfToImgInput").files[0];
  if(!file) return alert("Ø§Ø®ØªØ§Ø± PDF Ø£ÙˆÙ„Ø§Ù‹");
  if(!pdfjsLib) return alert("PDF engine not ready");
  const array=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:array}).promise;
  const maxPages=Math.min(pdf.numPages,5);
  for(let p=1;p<=maxPages;p++){
    const page=await pdf.getPage(p);
    const viewport=page.getViewport({scale:2});
    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=viewport.width; canvas.height=viewport.height;
    await page.render({canvasContext:ctx,viewport}).promise;
    const url=canvas.toDataURL("image/png");
    const a=document.createElement("a");
    a.href=url; a.download=`page-${p}.png`; a.click();
  }
  alert("ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙƒØµÙˆØ±.");
};

// ------- Timer -------
let timerTotal=25*60;
let timerLeft=timerTotal;
let timerInt=null;
function renderTimer(){
  const m=Math.floor(timerLeft/60).toString().padStart(2,"0");
  const s=(timerLeft%60).toString().padStart(2,"0");
  $("#timerDisplay").textContent=`${m}:${s}`;
}
renderTimer();

function setTimerMinutes(min){
  timerTotal=min*60; timerLeft=timerTotal; renderTimer();
  localStorage.setItem("atlas-timer-min",min);
}
(function(){
  const m=+localStorage.getItem("atlas-timer-min");
  if(m) setTimerMinutes(m);
})();

$("#startTimer").onclick=()=>{
  if(timerInt) return;
  timerInt=setInterval(()=>{
    timerLeft--;
    if(timerLeft<=0){
      clearInterval(timerInt); timerInt=null; timerLeft=0;
      alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª âœ…");
    }
    renderTimer();
  },1000);
};
$("#pauseTimer").onclick=()=>{
  clearInterval(timerInt); timerInt=null;
};
$("#resetTimer").onclick=()=>{
  timerLeft=timerTotal; renderTimer();
};
$$("[data-preset]").forEach(b=>{
  b.onclick=()=>setTimerMinutes(+b.dataset.preset);
});
$("#applyCustom").onclick=()=>{
  const m=+$("#customMinutes").value||25;
  setTimerMinutes(Math.max(1,m));
};

// ------- Online tag pulse -------
setInterval(()=>{
  $(function(){ const T=i18n[currentLang]||i18n.ar; $("#onlineTag").textContent = (navigator.onLine? T.online_on : T.online_off); })();
},1500);

// ------- Boot -------
applyLang(currentLang);
(async function boot(){
  await loadTracker();
  renderNotesList();
  setEditorEmpty();
})();
</script>

</body>
</html>
